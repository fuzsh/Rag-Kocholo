{
    "id": "dbpedia_464_1",
    "rank": 78,
    "data": {
        "url": "https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/mac-os-architecture/macos-iokit",
        "read_more_link": "",
        "language": "en",
        "title": "macOS IOKit",
        "top_image": "https://2783428383-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2FmuMguNrsRx2mNyNqEox4%2Fsocialpreview%2FNtYxX5Um1Ml0KhPq6gZR%2Ffondo.png?alt=media&token=257c330a-9e87-4c69-bb95-c0b54588ea79",
        "meta_img": "https://2783428383-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2FmuMguNrsRx2mNyNqEox4%2Fsocialpreview%2FNtYxX5Um1Ml0KhPq6gZR%2Ffondo.png?alt=media&token=257c330a-9e87-4c69-bb95-c0b54588ea79",
        "images": [
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F2783428383-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fcollections%252FmuMguNrsRx2mNyNqEox4%252Ficon%252F1qCJ0VIDlWcvGSecYCDq%252Ffondo.png%3Falt%3Dmedia%26token%3D1e721267-450f-43f3-861b-6c4f93278e93&width=32&dpr=4&quality=100&sign=61472716&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F2783428383-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fcollections%252FmuMguNrsRx2mNyNqEox4%252Ficon%252F1qCJ0VIDlWcvGSecYCDq%252Ffondo.png%3Falt%3Dmedia%26token%3D1e721267-450f-43f3-861b-6c4f93278e93&width=32&dpr=4&quality=100&sign=61472716&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FPq3VYU8uUd0iuPA6UznM%252Fimage.png%3Falt%3Dmedia%26token%3Dec905471-88ed-47b5-9304-bce167a907e1&width=768&dpr=4&quality=100&sign=a1c488c0&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FwIAtCM7P8Ju0ysZKiiqt%252Fimage.png%3Falt%3Dmedia%26token%3D7ddee35d-7b7c-49e2-b8a1-b757e45f4836&width=768&dpr=4&quality=100&sign=7b0901dc&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FGFvxMTVzk6xYhEd0XWRv%252Fimage.png%3Falt%3Dmedia%26token%3D96c8500e-a62e-43a5-bdae-9d0640d1a8dc&width=768&dpr=4&quality=100&sign=87436a6a&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FHIVt9HlnLA04MzjRmlEx%252Fimage.png%3Falt%3Dmedia%26token%3D48444d25-d810-4cad-aea6-3ff3dacaffcc&width=768&dpr=4&quality=100&sign=4e39d445&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fxj9emWA535XnxD84F2aK%252Fimage.png%3Falt%3Dmedia%26token%3D64df1086-7009-4456-89dc-5c014c086a3d&width=768&dpr=4&quality=100&sign=98d2daaf&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FYtBlH8UPH2qgF5D8VSwI%252Fimage.png%3Falt%3Dmedia%26token%3Dfb4c2fdd-fbe4-4ed6-83a7-ca7522ac183c&width=768&dpr=4&quality=100&sign=bd14f34a&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FBlcXz052QnQiHqaPXp57%252Fimage.png%3Falt%3Dmedia%26token%3D6a8e1c62-bdd3-4ddd-b474-cc126f93170f&width=768&dpr=4&quality=100&sign=2d03daeb&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FIhoitgpxFQTcxkjqY6ec%252Fimage.png%3Falt%3Dmedia%26token%3De6ffaea7-5557-4a2d-81ae-ce22a0eece80&width=768&dpr=4&quality=100&sign=7fd910a0&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FdiGatBZo7KX3550oK9Ej%252Fimage.png%3Falt%3Dmedia%26token%3D077be647-3cf6-42ec-b795-e84f89b74656&width=768&dpr=4&quality=100&sign=caa32b41&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252FBul0XJ4G56SZuHdLjVad%252Fimage.png%3Falt%3Dmedia%26token%3Dd6e9d3d3-14ce-451c-b00b-fe676c5cb965&width=768&dpr=4&quality=100&sign=edec5a22&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fxuye1g7RZ6KEyay4bbmB%252Fimage.png%3Falt%3Dmedia%26token%3D4a2d6bf4-2745-4d90-8a64-a8c3c6383e3f&width=768&dpr=4&quality=100&sign=8349fd4e&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fgit-blob-ce8af1068db7be4ad9003f8ddb02fea8f943f1a4%252Farte.png%3Falt%3Dmedia&width=40&dpr=4&quality=100&sign=f338524c&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fgit-blob-ce8af1068db7be4ad9003f8ddb02fea8f943f1a4%252Farte.png%3Falt%3Dmedia&width=40&dpr=4&quality=100&sign=f338524c&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fgit-blob-54ee1fb931f39d1e6f50150361b6aa1927f4ee88%252Fgrte.png%3Falt%3Dmedia&width=40&dpr=4&quality=100&sign=248ef1d0&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fgit-blob-54ee1fb931f39d1e6f50150361b6aa1927f4ee88%252Fgrte.png%3Falt%3Dmedia&width=40&dpr=4&quality=100&sign=248ef1d0&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fgit-blob-ce8af1068db7be4ad9003f8ddb02fea8f943f1a4%252Farte.png%3Falt%3Dmedia&width=40&dpr=4&quality=100&sign=f338524c&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fgit-blob-ce8af1068db7be4ad9003f8ddb02fea8f943f1a4%252Farte.png%3Falt%3Dmedia&width=40&dpr=4&quality=100&sign=f338524c&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fgit-blob-54ee1fb931f39d1e6f50150361b6aa1927f4ee88%252Fgrte.png%3Falt%3Dmedia&width=40&dpr=4&quality=100&sign=248ef1d0&sv=1",
            "https://book.hacktricks.xyz/~gitbook/image?url=https%3A%2F%2F129538173-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-L_2uGJGU7AVNRcqRvEi%252Fuploads%252Fgit-blob-54ee1fb931f39d1e6f50150361b6aa1927f4ee88%252Fgrte.png%3Falt%3Dmedia&width=40&dpr=4&quality=100&sign=248ef1d0&sv=1"
        ],
        "movies": [],
        "keywords": [],
        "meta_keywords": [
            ""
        ],
        "tags": null,
        "authors": [],
        "publish_date": "2024-07-19T09:07:11.563000+00:00",
        "summary": "",
        "meta_description": "",
        "meta_lang": "en",
        "meta_favicon": "https://2783428383-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/collections%2FmuMguNrsRx2mNyNqEox4%2Ficon%2F1qCJ0VIDlWcvGSecYCDq%2Ffondo.png?alt=media&token=1e721267-450f-43f3-861b-6c4f93278e93",
        "meta_site_name": "",
        "canonical_link": "https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/mac-os-architecture/macos-iokit",
        "text": "Basic Information\n\nThe I/O Kit is an open-source, object-oriented device-driver framework in the XNU kernel, handles dynamically loaded device drivers. It allows modular code to be added to the kernel on-the-fly, supporting diverse hardware.\n\nIOKit drivers will basically export functions from the kernel. These function parameter types are predefined and are verified. Moreover, similar to XPC, IOKit is just another layer on top of Mach messages.\n\nIOKit XNU kernel code is opensourced by Apple in https://github.com/apple-oss-distributions/xnu/tree/main/iokit. Moreover, the user space IOKit components are also opensource https://github.com/opensource-apple/IOKitUser.\n\nHowever, no IOKit drivers are opensource. Anyway, from time to time a release of a driver might come with symbols that makes it easier to debug it. Check how to get the driver extensions from the firmware here.\n\nIt's written in C++. You can get demangled C++ symbols with:\n\nDrivers\n\nIn macOS they are located in:\n\n/System/Library/Extensions\n\nKEXT files built into the OS X operating system.\n\n/Library/Extensions\n\nKEXT files installed by 3rd party software\n\nIn iOS they are located in:\n\n/System/Library/Extensions\n\nUntil the number 9 the listed drivers are loaded in the address 0. This means that those aren't real drivers but part of the kernel and they cannot be unloaded.\n\nIn order to find specific extensions you can use:\n\nTo load and unload kernel extensions do:\n\nIORegistry\n\nThe IORegistry is a crucial part of the IOKit framework in macOS and iOS which serves as a database for representing the system's hardware configuration and state. It's a hierarchical collection of objects that represent all the hardware and drivers loaded on the system, and their relationships to each other.\n\nYou can get the IORegistry using the cli ioreg to inspect it from the console (specially useful for iOS).\n\nYou could download IORegistryExplorer from Xcode Additional Tools from https://developer.apple.com/download/all/ and inspect the macOS IORegistry through a graphical interface.\n\nIn IORegistryExplorer, \"planes\" are used to organize and display the relationships between different objects in the IORegistry. Each plane represents a specific type of relationship or a particular view of the system's hardware and driver configuration. Here are some of the common planes you might encounter in IORegistryExplorer:\n\nIOService Plane: This is the most general plane, displaying the service objects that represent drivers and nubs (communication channels between drivers). It shows the provider-client relationships between these objects.\n\nIODeviceTree Plane: This plane represents the physical connections between devices as they are attached to the system. It is often used to visualize the hierarchy of devices connected via buses like USB or PCI.\n\nIOPower Plane: Displays objects and their relationships in terms of power management. It can show which objects are affecting the power state of others, useful for debugging power-related issues.\n\nIOUSB Plane: Specifically focused on USB devices and their relationships, showing the hierarchy of USB hubs and connected devices.\n\nIOAudio Plane: This plane is for representing audio devices and their relationships within the system.\n\n...\n\nDriver Comm Code Example\n\nThe following code connects to the IOKit service \"YourServiceNameHere\" and calls the function inside the selector 0. For it:\n\nit first calls IOServiceMatching and IOServiceGetMatchingServices to get the service.\n\nIt then establish a connection calling IOServiceOpen.\n\nAnd it finally calls a function with IOConnectCallScalarMethod indicating the selector 0 (the selector is the number the function you want to call has assigned).\n\nThere are other functions that can be used to call IOKit functions apart of IOConnectCallScalarMethod like IOConnectCallMethod, IOConnectCallStructMethod...\n\nReversing driver entrypoint\n\nYou could obtain these for example from a firmware image (ipsw). Then, load it into your favourite decompiler.\n\nYou could start decompiling the externalMethod function as this is the driver function that will be receiving the call and calling the correct function:\n\nThat awful call demagled means:\n\nNote how in the previous definition the self param is missed, the good definition would be:\n\nActually, you can find the real definition in https://github.com/apple-oss-distributions/xnu/blob/1031c584a5e37aff177559b9f69dbd3c8c3fd30a/iokit/Kernel/IOUserClient.cpp#L6388:\n\nWith this info you can rewrite Ctrl+Right -> Edit function signature and set the known types:\n\nThe new decompiled code will look like:\n\nFor the next step we need to have defined the IOExternalMethodDispatch2022 struct. It's opensource in https://github.com/apple-oss-distributions/xnu/blob/1031c584a5e37aff177559b9f69dbd3c8c3fd30a/iokit/IOKit/IOUserClient.h#L168-L176, you could define it:\n\nNow, following the (IOExternalMethodDispatch2022 *)&sIOExternalMethodArray you can see a lot of data:\n\nChange the Data Type to IOExternalMethodDispatch2022:\n\nafter the change:\n\nAnd as we now in there we have an array of 7 elements (check the final decompiled code), click to create an array of 7 elements:\n\nAfter the array is created you can see all the exported functions:"
    }
}