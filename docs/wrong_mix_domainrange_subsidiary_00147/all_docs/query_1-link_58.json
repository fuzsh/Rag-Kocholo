{
    "id": "wrong_mix_domainrange_subsidiary_00147_1",
    "rank": 58,
    "data": {
        "url": "https://clouddocs.f5.com/cloud/public/v1/azure/Azure_deploy_gwlb.html",
        "read_more_link": "",
        "language": "en",
        "title": "IP Virtual Edition with Azure Gateway Load Balancer",
        "top_image": "https://cdn.f5.com/favicon.ico",
        "meta_img": "https://cdn.f5.com/favicon.ico",
        "images": [
            "https://clouddocs.f5.com/cloud/public/v1/_images/gwlb-intro.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/gwlb-architect.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/pktDecap-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/gwlb-accessEx.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/gwlb-accessEx2.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/resrcGrp-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/subnet-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/subnet2-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/subnet3-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/secGrp1-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/secGrp2-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/secGrp3-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/netInterface1-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/netInterface2-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/VEinstance-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM2-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM3-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM4-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM5-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM6-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM7-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM8-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM9-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM12-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/createVM11-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/create-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/bepool-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/confVE1-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/confVE2-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/license12.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/license22.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/license32.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/provVE1-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/provVE2-vnet10.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/vlansVE-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/vxlanProfile-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/vxlan-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/vxlan2-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/vxlan3-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/vxlan4-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/vxlan5-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/vxlan6-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/healthProbe-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/healthProbe2-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/healthProbe3-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/appVIP-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/appVIP2-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/appVIP3-gwlb.png",
            "https://clouddocs.f5.com/cloud/public/v1/_images/appVIP4-gwlb.png"
        ],
        "movies": [],
        "keywords": [],
        "meta_keywords": [
            ""
        ],
        "tags": null,
        "authors": [],
        "publish_date": null,
        "summary": "",
        "meta_description": "",
        "meta_lang": "",
        "meta_favicon": "https://cdn.f5.com/favicon.ico",
        "meta_site_name": "",
        "canonical_link": null,
        "text": "Version notice:\n\nDeploy F5 BIG-IP Virtual Edition with Azure Gateway Load BalancerÂ¶\n\nF5Â® BIG-IPÂ® Virtual Edition (VE) delivers a wide range of application and security services, aggregating your application portfolio under a single platform.\n\nMicrosoftâs Gateway Load Balancer (GWLB) is a SKU of the Azure Load Balancer portfolio designed for high performance and high availability scenarios with third-party Network Virtual Appliances (NVAs). With the capabilities of Gateway Load Balancer, you can easily deploy, scale, and manage NVAs. Chaining a Gateway Load Balancer to your public endpoint only requires one click.\n\nThe F5 BIG-IP VE and Azure GWLB integration enables the industry leading BIG-IP security services with the following benefits:\n\nSimplified connectivity - Leverage Azure native networking constructs to âinsertâ BIG-IP security services in different traffic flows.\n\nPublic scalability - Scale your deployment based on your actual usage. Horizontally scale your BIG-IP VEs.\n\nWhen to use GWLB?Â¶\n\nF5 BIG-IP VE delivers a wide-range of application and security services. Depending on the service and other requirements the BIG-IP VEs are typically deployed in one of two modes: Network mode or Proxy mode.\n\nNote\n\nAzure GWLB is only applicable today with Network deployment mode. First, you identify which deployment mode is relevant for you.\n\nOption 1 â Network (GWLB Supported):\n\nCommon use cases include Network firewall, DDoS protection, and Transparent WAF.\n\nFlow transparency is maintained (no source or destination NAT).\n\nDirecting traffic to the BIG-IP VEs is done using routing by the network, making sure traffic goes back to the same BIG-IP VE in order to maintain traffic symmetry is also based on routing.\n\nOption 2 â Proxy (not GWLB-supported)\n\nProviding ingress services to the application (WAF, LB, L7 DDoS, and Bot protection), services are applied to an application specific virtual server on the BIG-IP VE.\n\nThe BIG-IP VE source NAT (SNAT) manages the traffic to ensure that the return traffic arrives at the same BIG-IP VE; thus, maintaining traffic symmetry.\n\nDirecting userâs traffic to the BIG-IPâs is done using DNS. A FQDN will map to a specific virtual server on the BIG-IP VE.\n\nGWLB ArchitectureÂ¶\n\nThe following diagram illustrates a BIG-IP VE multi-NIC deployment in GWLB:\n\nThe previous diagram illustrates an example deployment of multiple standalone 2-NIC BIG-IP VEs (consult the BIG-IP VE Multi-NIC deployment guide).\n\nIn the previous diagram, the BIG-IP VE tier sits in the Provider Virtual Network and the application sits in the Consumer Virtual Network. Client traffic flows in the following sequence:\n\nConsumer Load Balancer\n\nProvider Azure Gateway Load Balancer\n\nBIG-IP Security Tier\n\nProvider Azure Gateway Load Balancer\n\nConsumer Load Balancer\n\nApplication Tier\n\nThis Provider VNET containing the BIG-IP Virtual Machines contain two subnets:\n\nAn external, public subnet, where you will create a virtual service(s) to accept tunneled application traffic\n\nA management subnet, where you can access the BIG-IP Configuration utility, which you use to configure BIG-IP VE.\n\nThe previous diagram illustrates high-level overview of packet decapsulation from the Azure Gateway Load Balancer.\n\nDisclaimer:\n\nThis guide does not include deploying the consumer portion or all the components a production environment may require.\n\nUse the following, individual parameters and values provided to create the previous example deployment and to customize according to your needs.\n\nAccessing the BIG-IP VEÂ¶\n\nThis guide demonstrates deploying one of the 2-NIC BIG-IP virtual machines in BIG-IP Tier illustrated in the previous diagram.\n\nImportant\n\nRestrict access to the BIG-IP Management UI (GUI and SSH) to trusted sources/networks only; for example, using Bastion Host/Bastion Service/Jumpbox, or other similar service.\n\nFor example:\n\nDeploying an appropriate access solution is outside the scope. See your cloud providerâs documentation for instructions on selecting and deploying an appropriate access solution. However, for simplicity and evaluation purposes only, the following steps describe provisioning a public IP address access to the Management UI.\n\nThe previous diagram illustrates an evaluation-only deployment of a standalone BIG-IP VE with two NICs, one for Management and one for Application traffic.\n\nDeployment guideÂ¶\n\nThe following sections outline steps to take for deploying a BIG-IP VE Multi-NIC with Azure GWLB. To create a multi-NIC deployment, you must first create an Azure Virtual Network with more than one subnet. Use this the network environment to host your virtual machines.\n\nCreate BIG-IP Virtual MachineÂ¶\n\nTo deploy the BIG-IP VE virtual machine, do the following:\n\nCreate additional network interfaces: External interface: 10.0.1.11\n\nDeploy the BIG-IP VE instance. Create BIG-IP Virtual machine with two NICS:\n\nManagement NIC\n\nExternal NIC\n\nCreate additional network interfacesÂ¶\n\nBy default, when deploying the BIG-IP virtual machine through the Azure Portal, it creates one NIC. To create a multiple-NIC BIG-IP, you must create additional NICs and attach them to the BIG-IP VE after initial creation.\n\nHowever, through automation (through the Azure CLI, Terraform, ARM templates), you can create virtual machines with multiple NICs without the need for stopping and restarting (see the following inline Azure CLI examples).\n\nNote\n\nFor multi-tenant, multi-service deployments, F5 recommends leveraging static IPs in order to help recreate Azure network configurations that match network configurations in your BIG-IP UCSs (BIG-IPâs backup files).\n\nFor complete details, see Azure documentation.\n\nIn the Azure Portal, navigate to All Services -> Network Interfaces -> Create.\n\nCreate the external NIC, using the following information:\n\nTextbox Value Resource Group example-rg Name external-nic Region East US Virtual network example-vnet subnet external (10.0.1.0/24) Private IP address assignment Static Private IP address 10.0.1.11 Security groups external-sg\n\nAt the prompt, click Next: Tags or Create.\n\nTo create network interfaces using the Azure CLI, type:\n\n# External NIC az network nic create --name external-nic -g example-rg --vnet-name example-vnet --subnet external --ip-forwarding --private-ip-address 10.0.1.11 --network-security-group external-nsg\n\nNote\n\nIf deploying through the CLI, you can also create the management NIC.\n\n# Management NIC az network nic create --name management-nic -g example-rg --vnet-name example-vnet --subnet management --ip-forwarding --network-security-group management-nsg --private-ip-address 10.0.0.11\n\nIf accessing management interface using a Public IP, do the following:\n\nCreate a public IP:\n\n# Public IP az network public-ip create --name management-public-ip -g example-rg --allocation-method Static\n\nCreate the NIC with public IP attached:\n\n# Management NIC az network nic create --name management-nic -g example-rg --vnet-name example-vnet --subnet management --ip-forwarding --network-security-group management-nsg --private-ip-address 10.0.0.11 --public-ip-address management-public-ip\n\nDeploy a BIG-IP VE virtual machineÂ¶\n\nFor complete details, see Azure documentation.\n\nTo create a virtual machine of BIG-IP VE, you deploy a version of it from the Azure Marketplace.\n\nVisit the Azure Marketplace.\n\nSearch for, âF5 BIG-IPâ.\n\nSelect the offering you want to deploy, and then click Get It Now.\n\nComplete the Account Information, and then click Continue.\n\nClick Create.\n\nOn Configure Virtual Machine Settings menu, complete the following information accordingly:\n\nSelect the Resource Group previously created.\n\nEnter the Virtual Machine Name.\n\nSelect the Region.\n\nSelect the appropriate Size (for example, a select an option with at least 2 cores, 8 GB of memory like DS3_v2). See the BIG-IP VE Support Matrix for more information.\n\nFor Authentication Type, select SSH, and complete the following information:\n\nTextbox Value Username Enter username. For SSH public key source Select Use existing public key option (see previous requirements). For SSH public key source Enter your SSH Public Key. Public Inbound Ports Select Allow Selected Ports, and enter SSH (22) and HTTPS (443)\n\nSelect the Networking tab and complete the following:\n\nExpand the Virtual Network list, select your Virtual Network.\n\nExpand the Subnet list, select the management subnet: 10.0.0.0/24.\n\nIn the NIC network security group, select the Advanced option.\n\nIn the Configure network security group list, select the management-sg security group.\n\nClick Next on the remaining tabs and complete all information as directed.\n\nOnce finished, on the Review + create page, review the summary, and then click Create.\n\nAfter the âYour deployment is completeâ message appears, select Go to resource.\n\nSelect the Overview menu, and then select Stop.\n\nImportant\n\nBefore logging in or making any changes, you must stop the BIG-IP VE. Doing so, enables you to attach the additional NICs.\n\nDo the following to change the Management IP to Static.\n\nUnder Settings -> Networking -> Network Interface, select a NIC (for example, bigip-vm262).\n\nUnder Settings -> IP Configurations, select ipconfig, and then change Assignment to Static.\n\nEnter the Management address: 10.0.0.11.\n\nClick Save.\n\nDo the following to attach the additional NICs (external-nic):\n\nNavigate to the Virtual Machine -> Settings -> Networking.\n\nClick Attach network interface.\n\nSelect the external-nic, and then click OK.\n\nRepeat these steps for the internal-nic.\n\nYou will now see two NICs attached to the virtual machine.\n\nRe-start the virtual machine.\n\nOnce the virtual machine Status displays, âRunning,â log into the Management IP.\n\nTo deploy the BIG-IP VE using the Azure CLI and substituting your own public SSH Key for ââssh-key-valuesâ, type:\n\naz vm create --name BIGIP-vm -g example-rg \\ --image f5-networks:f5-big-ip-best:f5-bigip-virtual-edition-25m-best-hourly:16.0.101000 \\ --size Standard_DS3_v2 \\ --nics management-nic external-nic \\ --admin-username azureuser \\ --ssh-key-values \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQClW+UyY2eWczwnEGcEtwR/ISURqmdQIpgicgVvUvZTilXYâ¦.\"\n\nCreate an Azure Gateway Load BalancerÂ¶\n\nDo the following to create the Azure Gateway Load Balancer:\n\nCreate Azure Gateway Load Balancer.\n\nCreate Backend Pool.\n\nCreate Inbound Rules and Health Monitor.\n\nCreate Azure Gateway Load BalancerÂ¶\n\nConsult the Azure documentation for complete information.\n\nIn the Azure portal, navigate to All Services -> Load balancers -> Create.\n\nEnter a Name (for example, example-gwlb).\n\nSelect SKU -> Gateway.\n\nClick Next -> Frontend IP Configuration.\n\nClick Create.\n\nTo create an Azure Gateway Load Balancer using the Azure CLI, type:\n\naz network lb create --name example-gwlb --sku Gateway -g example-rg --vnet-name example-vnet --subnet external --frontend-ip-name example-gwlb-frontend-ip --backend-pool-name example-backend-pool\n\nCreate a Backend PoolÂ¶\n\nProvide the values according to the table below. The Ports and IDs are used in the example deployment. However, you can use any valid ports or IDs that match values used the Network Security Groups and BIG-IP configurations.\n\nName Value Description Name example-backend-pool The name of your backend pool. Virtual Network example-vnet The provider virtual network. Internal Port 2002 The UDP port on which BIG-IP will accept internal tunnel traffic. Internal Identifier 802 The ID used to identify the internal VLAN. External Port 2001 The UDP port on which BIG-IP will accept external tunnel traffic. External Identifier 801 The ID used to identify the internal VLAN.\n\nConsult the Azure documentation for complete information.\n\nEnter a Name like, example-backend-pool.\n\nIn the Virtual Network text box, select example-vnet.\n\nIn the Type text box, select Internal and External.`\n\nIn the Internal Port text box, enter 2002.\n\nIn the Internal Identifier text box, enter 802.\n\nIn the External Port text box, enter 2001.\n\nIn the External Identifier text box, enter 801.\n\nSelect Virtual Machines, in the filter by name text box, enter bigip-vm, and then select your BIG-IP virtual machine from the list.\n\nSelect Next: Inbound rules.\n\nTo create back end pool using the Azure CLI, type:\n\naz network lb address-pool tunnel-interface add -g example-rg --lb-name example-gwlb --address-pool example-backend-pool --type external --protocol vxlan --identifier 801 --port 2001 az network lb address-pool tunnel-interface update -g example-rg --lb-name example-gwlb --address-pool example-backend-pool --index 0 --type internal --protocol vxlan --identifier 802 --port 2002 # Add BIG-IP to Backend Pool az network lb address-pool address add -n bigip-vm-address --ip-address 10.0.1.11 -g example-rg --lb-name example-gwlb --pool-name example-backend-pool --vnet example-vnet\n\nCreate Inbound Rules and Health MonitorÂ¶\n\nConsult the Azure documentation for complete information.\n\nClick Add a Load balancing rule.\n\nEnter a Name like, type example-lb-rule.\n\nIn the Protocol text box, enter All.\n\nIn the Port text box, enter 0.\n\nIn the Backend Port, enter 0.\n\nSelect Health Probe, click Create New.\n\nEnter a Name like, example-health-probe.\n\nIn the Protocol, select HTTP.\n\nIn the Port, enter 24500 (must match the Security Groups and BIG-IP Configuration).\n\nClick OK.\n\nIn the Backend Pool, select example-backend-pool.\n\nClick Next: Outbound Rule, click Next: Tags, and then click Review: Create.\n\nTo create back end pool using the Azure CLI, type:\n\naz network lb probe create --name example-health-probe -g example-rg --lb-name example-gwlb --protocol http --port 24500 --path /healthcheck az network lb rule create --name example-lb-rule -g example-rg --lb-name example-gwlb --protocol all --frontend-port 0 --backend-port 0 --frontend-ip-name example-gwlb-frontend-ip --backend-pool-name example-backend-pool --probe-name example-health-probe --disable-outbound-snat true\n\nConfigure BIG-IP VEÂ¶\n\nDepending on how you have configured access to the Management port, you will now login and configure BIG-IP VE so that traffic passes through it to your application servers.\n\nSet the admin password for BIG-IP VE. Before you can license and provision BIG-IP VE, use SSH and your key pair to connect to the instance and set a strong password. In tmsh, type modify auth password admin.\n\nLicense BIG-IP VE. Use the admin account to log in to the BIG-IP Configuration utility (https://<MANAGEMENT-IP>). If you have trouble accessing the Configuration utility, check the Azure security groups to ensure that they allow the appropriate traffic.\n\nProvision BIG-IP VE. Enable the modules you need.\n\nCreate external VLAN. These VLANs and their interfaces directly correspond to the Azure external vlan and their interfaces.\n\nexternal VLAN interface: 1.1\n\nCreate self IP. These static IP addresses provide a way for application traffic to reach the BIG-IP system. These addresses should match the private IP addresses you assigned to the external subnets in Azure.\n\nExternal self IP: 10.0.1.11\n\nCreate VXLAN Profiles:\n\ngwlb-ext-vxlan-prof\n\ngwlb-int-vxlan-prof\n\nCreate VXLAN Tunnels:\n\ngwlb-external-tun\n\ngwlb-internal-tun\n\nCreate VXLAN Groups:\n\nvg-1\n\nvg-2\n\nCreate Self-IPs for tunnels:\n\nExternal Tunnel Self IP: 192.168.1.11/28\n\nInternal Tunnel Self IP: 192.168.2.11/28\n\nCreate static L2 entries. Similar to how Self-IPs bind a network to vlans, these static entries will bind tunnels to their layer 2.\n\nCreate a Virtual Server for the GWLB Health Probe. This provides the upstream Gateway a system level health view for the BIG-IPs.\n\nCreate application VIPs to listen for tunnel traffice. The virtual server(s) provide a destination for your inbound web traffic from the tunnel Virtual IP:\n\n0.0.0.0:80\n\n0.0.0.0:443\n\nSet the admin password for BIG-IP VEÂ¶\n\nWhen you first boot BIG-IP VE, you must connect to the instance and create a strong admin password. You will use the admin account and password to access the BIG-IP Configuration utility. If the management interface can access the Internet, ensure the password is secure.\n\nConnect to BIG-IP VE using one of the following options:\n\nFrom a Jumpbox or similar service that has access to your management network, at the command prompt, navigate to the folder where you saved your ssh key and type:\n\nssh -i <YOUR-PRIVATE-KEY> azureuser@<MANAGEMENT-IP>\n\nIf you have configured a public IP, type:\n\nssh -i <YOUR-PRIVATE-KEY> azureuser@<MANAGEMENT-PUBLIC-IP>\n\nOpen PuTTy and do the following:\n\nIn the Host Name (or IP address) text box, enter the external IP address, for example:\n\nIn the Category pane, click Connection -> SSH -> Auth.\n\nIn the Private key file for authentication text box, choose your .ppk file.\n\nClick Open, if a host key warning appears, click OK, at the terminal login screen, type: azureuser, and then press Enter.\n\nYou are auto-logged into TMSH (Traffic Management Shell). To change to the shell, type: bash.\n\nModify the admin password, type: modify auth password azureuser.\n\nAt the New Password prompt, enter the new password, and then press Enter.\n\nAt the Confirm password prompt, re-enter the password, and then press Enter.\n\nTo ensure that the system saves the changes, type: save sys config, and then press Enter. You will see the following message: Saving Ethernet mapping...done.\n\nLicense BIG-IP VEÂ¶\n\nImportant\n\nIn the following procedure, where you see admin, substitute with azureuser.\n\nYou must enter license information before you can use BIG-IP VE.\n\nOpen a web browser and log in to the BIG-IP Configuration utility by using https with the external IP address, for example: https://<external-ip-address>. The username is admin and the password is the one you set previously.\n\nOn the Setup Utility Welcome page, click Next.\n\nOn the General Properties page, click Activate.\n\nIn the Base Registration key field, enter the case-sensitive registration key from F5.\n\nFor Activation Method, if you have a production or Eval license, choose Automatic and click Next.\n\nIf you chose Manual, complete these steps:\n\nIn the Step 1: Dossier field, copy all of the text and then click Click here to access F5 Licensing Server.\n\nA separate web page opens.\n\nOn the new page, click Activate License.\n\nIn the Enter your dossier field, paste the text and click Next.\n\nAccept the agreement and click Next.\n\nOn the Activate F5 Product page, copy the license text in the box. Now go back to the BIG-IP Configuration utility and paste the text into the Step 3: License field.\n\nClick Next.\n\nThe BIG-IP VE system registers the license and logs you out. When the configuration change is successful, click Continue to provision BIG-IP VE.\n\nProvision BIG-IP VEÂ¶\n\nYou must confirm the modules you want to run before you can begin to work in the BIG-IP Configuration utility.\n\nOpen a web browser and log in to the BIG-IP Configuration utility.\n\nOn the Resource Provisioning screen, change settings if necessary and click Next.\n\nOn the Device Certificates menu, click Next.\n\nOn the Platform menu, in the Host Name text box, and then click Next.\n\nOn the Network menu, click Finished.\n\nCreate external VLANsÂ¶\n\nIn BIG-IP VE, you must create an external VLAN that corresponds to the Azure VPC subnets.\n\nIn the BIG-IP VE Configuration utility, on the Setup Utility Network menu, under Advanced Network Configuration, click Finished.\n\nOn the Main tab, navigate to Network -> VLANs.\n\nClick Create and complete the following information for the external VLAN.\n\nText box Value :guilabel:Name external Interface 1.1 Tagging: Untagged MTU 9001\n\nClick Finished.\n\nThe screen refreshes, and the new VLAN is in the list.\n\nTo create an external VLAN in BIG-IP CLI, type:\n\ntmsh create net vlan external interfaces add { 1.1 } mtu 9001\n\nCreate self IPÂ¶\n\nBefore starting these steps, in Azure, note the primary private IP addresses for the external network interface (device index 1).\n\nIn the BIG-IP VE Configuration utility, on the Main tab, select Network -> Self IPs.\n\nClick Create and complete the appropriate information for the external-self IP address.\n\nText box Value Name external-self IP Address 10.0.1.11 Netmask 255.255.255.0 VLAN/Tunnel external Port Lockdown Allow All\n\nClick Finished.\n\nThe screen refreshes, and the new self IP address is in the list.\n\nTo create a self IP in BIG-IP CLI, type:\n\ntmsh create net self external-self address 10.0.1.11/24 vlan external allow-service all\n\nCreate VXLAN ProfilesÂ¶\n\nIn the BIG-IP VE Configuration utility, on the Main tab, select Network -> Tunnels -> Profiles -> VXLAN.\n\nClick Create and complete the following information for the external Tunnel, selecting Custom to access the Port and Flooding Type settings.\n\nText box Value Name gwlb-ext-vxlan-prof Parent Profile vxlan Port 2001 Flooding Type None\n\nClick Repeat and complete the following information for the internal Tunnel, selecting Custom to access the Port and Flooding Type settings:\n\nText box Value Name gwlb-int-vxlan-prof Parent Profile vxlann Port 2002 Flooding Type None\n\nClick Finished.\n\nTo create VXLAN Profiles using BIG-IP CLI, type:\n\ntmsh create net tunnels vxlan gwlb-ext-vxlan-prof port 2001 flooding-type none tmsh create net tunnels vxlan gwlb-int-vxlan-prof port 2002 flooding-type none\n\nCreate VXLAN TunnelsÂ¶\n\nIn the BIG-IP VE Configuration utility, on the Main tab, click Network -> Tunnels -> Tunnel List.\n\nClick Create and complete the appropriate information for the external Tunnel:\n\nText box Value Name qwlb-external-tun Key 801 Profile gwlb-ext-vxlan-prof Local Address 10.0.1.11 Secondary Address Any MTU 1450\n\nClick Repeat and complete the appropriate information for the internal Tunnel:\n\nText box Value Name qwlb-external-tun Key 801 Profile gwlb-ext-vxlan-prof Local Address 10.0.1.11 Secondary Address Any MTU 1450\n\nClick Finished.\n\nTo create VXLAN tunnels in BIG-IP CLI, type:\n\ntmsh create net tunnels tunnel gwlb-external-tun key 801 profile gwlb-ext-vxlan-prof local-address 10.0.1.11 remote-address any mtu 1450 tmsh create net tunnels tunnel gwlb-internal-tun key 802 profile gwlb-int-vxlan-prof local-address 10.0.1.11 remote-address any mtu 1450\n\nCreate VXLAN GroupsÂ¶\n\nIn the BIG-IP VE Configuration utility, select the Main tab, click Network -> Vlans -> Vlan Groups, and then click Create.\n\nComplete the following information to create the external vlan group:\n\nText box Value Name vg-1 Vlans gwlb-external-tunnel Local Address 10.0.1.11 Bridge All Traffic enabled\n\nClick Repeat, complete the following information to create the internal vlan group:\n\nText box Value Name vg-2 Vlans gwlb-external-tunnel Local Address 10.0.1.11 Bridge All Traffic enabled\n\nTo create VXLAN groups in BIG-IP CLI, type:\n\ntmsh create net vlan-group vg-1 members add { gwlb-external-tun } bridge-traffic enabled tmsh create net vlan-group vg-2 members add { gwlb-internal-tun } bridge-traffic enabled\n\nCreate Self-IPs for TunnelsÂ¶\n\nIn the BIG-IP VE Configuration utility, on the Main tab, click Network -> Self-IPs, and then click Create.\n\nComplete the following information to create a Self-IP for the external VXLAN tunnel:\n\nText box Value Name vxlan-external-self IP Address 192.168.1.11 Netmask 255.255.255.240 Port Lockdown Allow All\n\nClick Repeat and compelte the following informaiton to create a Self-IP for the internal VXLAN tunnel:\n\nText box Value Name vxlan-external-self IP Address 192.168.2.11 Netmask 255.255.255.240 Port Lockdown Allow All\n\nClick Finished.\n\nTo create Self-IP for tunnels in BIG-IP CLI, type:\n\ntmsh create net self vxlan-external-self address 192.168.1.11/28 vlan vg-1 allow-service all tmsh create net self vxlan-internal-self address 192.168.2.11/28 vlan vg-2 allow-service all\n\nCreate Static L2 entriesÂ¶\n\nCreate static ARP entry that forwards traffic to GWLB.\n\nSelect Network -> Arp -> Static List, and then click Create.\n\nText box Value Description Name gwlb-int-vxlan-prof IP Address 192.168.1.1 Must match the Virtual Service on the Tunnelâs Pool Member. Mac Address ff:ff:ff:ff:ff:aa Arbitrary value\n\nClick Repeat and complete the following information for the internal Tunnel:\n\nText box Value Description Name gwlb-int-vxlan-prof IP Address 192.168.2.1 Must match the Virtual Service on the Tunnelâs Pool Member. Mac Address ff:ff:ff:ff:ff:aa Arbitrary value\n\nClick Finished.\n\nTo create FDB entry for external/internal BIG-IP VXLAN tunnel that points to GWLB, on the Main tab select Network -> Tunnels -> Tunnel-List, and then select External tunnel (gwlb-external-tunnel) option.\n\nSelect Tunnel Static Forwarding Table, and then click Create.\n\nText box Value Description Mac Address 12:34:56:78:9a:bc Must match GWLB mac address. This can vary depending upon your environment. To obtain, see the following TMSH CLI example. Endpoint 10.0.1.4 The Gateway IP address Description GWLB\n\nClick Finished.\n\nTo create a FDB entry for the internal VXLAN tunnel, on the Main tab, select Network -> Tunnels -> Tunnel-List, and then click the external tunnel (gwlb-internal-tunnel) option.\n\nClick the Tunnel Static Forwarding Table, and then Create.\n\nComplete the following information:\n\nText box Value Description Mac Address ff:ff:ff:ff:ff:bb Must match static ARP entry on Internal Tunnel. Endpoint 10.0.1.4 The Gateway IP address Description GWLB\n\nClick Finished.\n\nTo create Static L2 entries in BIG-IP CLI, type:\n\ntmsh create net arp static-arp-entry-external ip-address 192.168.1.1 mac-address ff:ff:ff:ff:ff:aa tmsh create net arp static-arp-entry-internal ip-address 192.168.2.1 mac-address ff:ff:ff:ff:ff:bb tmsh modify net fdb tunnel gwlb-external-tun records add { 12:34:56:78:9a:bc { description gwlb endpoint 10.0.1.4 } } tmsh modify net fdb tunnel gwlb-internal-tun records add { ff:ff:ff:ff:ff:bb { description gwlb endpoint 10.0.1.4 } } # Example GATEWAY_ADDRESS=\"10.0.1.4\" GATEWAY_MAC=$(arping -I external -c 1 $GATEWAY_ADDRESS | egrep -o '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}') tmsh modify net fdb tunnel gwlb-external-tun records add { $GATEWAY_MAC { description gwlb endpoint $GATEWAY_ADDRESS } } tmsh modify net fdb tunnel gwlb-internal-tun records add { $GATEWAY_MAC { description gwlb endpoint $GATEWAY_ADDRESS } }\n\nCreate Virtual Service for GWLB Health ProbeÂ¶\n\nCreate a VIP that responds to the Gateway Loadbalancerâs Health Probe. This virtualThe Virtualâs port must match the port used by the Health Monitor. The previous examples use TCP 24500.\n\nIn the BIG-IP VE Configuration utility, on the Main tab, click Local Traffic -> iRules, and then click Create.\n\nIn the Name text box enter http-server.\n\nIn the Definition, enter the following:\n\nwhen HTTP_REQUEST { HTTP::respond 200 'System Responding' }\n\nClick Finished.\n\nTo create the Virtual Service, in the BIG-IP VE Configuration utility, on the Main tab, select Local Traffic -> Virtual Servers, and then click create.\n\nComplete the following information:\n\nText box Value Description Name gwlb-health-probe-vs Name of Virtual Server Destination Address/Mask 10.0.1.11 Must match the Self-IP and Private Address of the External NIC Service Port 24500 Arbitrary value that must match what is configured on the GWLB Health Probe Port and Security Groups. HTTP Profile (Client) http A http profile must be applied for an http iRule. iRules http-server Select the iRule previously entered.\n\nTo create Virtual Service for GWLB Health Probe using the BIG-IP CLI, type:\n\n# Create Virtual Service to answer GWLB Health Probe tmsh create ltm rule /Common/http-server when HTTP_REQUEST { HTTP::respond 200 \\'System Responding\\'} tmsh create ltm virtual gwlb-health-probe-vs destination 0.0.0.0:24500 mask 0.0.0.0 ip-protocol tcp profiles add { http tcp } vlans-enabled vlans add { external } rules { http-server }\n\nCreate Application VIPs to listen for tunnel trafficÂ¶\n\nDisclaimer: The following virtual servers are used to illustrate passing traffic. Customize according to your use case (for example, adding security policies, F5 BIG-IP Advanced WAF policies, leverages F5Â® BIG-IPÂ® Telemetry Streaming streaming to send Azure log analytics, Insights, or similar data).\n\nThe required component settings for this solution include:\n\nDisable Address and Port Translation.\n\nEnable Address and Port Translation on the tunnels.\n\nForward traffic through the tunnels using the pools with tunnel destinations.\n\nCreate a pool for tunnel traffic arriving on the external tunnel\n\nTraffic goes through BIG-IP VE to a pool. The pool member will be a tunnel endpoint, so traffic is forwarded through the tunnel.\n\nClick the Main tab, and select Local Traffic -> Nodes.\n\nClick Create.\n\nIn the Name text box, enter internal-tunnel-node.\n\nIn the Address text box, enter 192.168.2.1.\n\nIn the Health Monitor text box, select None.\n\nTraffic goes through BIG-IP VE to a pool. The pool member will be a tunnel endpoint, so traffic is forwarded through the tunnel.\n\nClick the Main tab, select Local Traffic -> Pools.\n\nClick Create.\n\nIn the Name text box, enter internal-tunnel-pool.\n\nIn the New Members section, select the internal-tunnel-node previously created.\n\nIn the Service Port, select Select All Services.\n\nClick Add. The list now contains the member.\n\nClick Finished.\n\nTo create Application VIPs using the BIG-IP CLI, type:\n\ntmsh create ltm node internal-tunnel-node address 192.168.2.1 monitor none tmsh create ltm pool internal-tunnel-pool members add { internal-tunnel-node:0 } monitor none\n\nCreate a Virtual Server(s) for incoming tunnel traffic\n\nYou must create a virtual server for traffic arriving on the external tunnel. Application traffic is forwarded through the internal tunnel.\n\nIn the BIG-IP Configuration utility, click the Main tab, select Local Traffic -> Virtual Servers.\n\nClick Create,and click Configuration -> Advanced.\n\nComplete the following information:\n\nText box Value Description Name ingress-vs-http Destination Address/Mask 0.0.0.0/0 Service Port 80 Enter a port number or a service name from the Service Port list that matches your Consumer LB port. TCP Profile (clientside) f5-tcp-wan TCP Profile (serverside) f5-tcp-lan HTTP Profile http Vlans gwlb-external-tun Source Address Translation None Address Translation Disabled Port Translation Disabled Default Pool internal-tunnel-pool\n\nConfigure any other settings as needed, and then click Finished.\n\nTo create VIPs for incoming tunnel traffic using the BIG-IP CLI, type:\n\ntmsh create ltm virtual ingress-vs-http destination 0.0.0.0:80 mask any ip-protocol tcp profiles add { f5-tcp-wan { context clientside } f5-tcp-lan { context serverside } http } vlans-enabled vlans add { gwlb-external-tun } translate-address disabled source-port preserve-strict pool internal-tunnel-pool\n\nCreate Virtual Server(s) for outgoing tunnel traffic\n\nOptionally, you can create a virtual server for outgoing traffic. Application traffic arrives on the internal tunnel and is forwarded back out through the external tunnel.\n\nCreate a Pool for outgoing tunnel traffic\n\nClick the Main tab, select Local Traffic -> Nodes.\n\nClick Create.\n\nIn the Name text box, enter external-tunnel-node.\n\nIn the Address text box, enter ``192.168.1.1`.\n\nIn the Health Monitor text box, select None.\n\nClick the Main tab, click :menuselection:Local Traffic -> Pools`.\n\nClick Create.\n\nIn the Name text box, enter external-tunnel-pool.\n\nIn the New Members section, select the external-tunnel-node you previously created.\n\nSet Service Port to Select All Services.\n\nClick Add. The list now contains the member.\n\nTo create a pool for outgoing tunnel traffic using TMSH CLI, type:\n\n# Create Pool to process Outgoing Tunnel Traffic tmsh create ltm node external-tunnel-node address 192.168.1.1 monitor none tmsh create ltm pool external-tunnel-pool members add { external-tunnel-node:0 } monitor none\n\nCreate a virtual server for outgoing tunnel traffic\n\nIn the BIG-IP Configuration Utility, on the Main tab, and select Local Traffic -> Virtual Servers.\n\nClick Create, set Configuration to Advanced, and then complete the following information:\n\nText box Value Description Name egress-vs-http Type Performance-Layer4 Service Port 80 Use a port number or a service name from the Service Port list that matches your Consumer LB port. Type Protocols All Profilel fastL4 Vlans (enabled) gwlb-internal-tun Source Address Translation None Address Translation Disabled Port Translation Disabled Default Pool external-tunnel-pool\n\nConfigure any other settings as needed, and then click Finished.\n\nTo create a virtual server using TMSH CLI, type:\n\n# Create Virtual Service to process Outgoing Tunnel Traffic tmsh create ltm virtual egress-vs-http destination 0.0.0.0:80 mask any ip-protocol any vlans-enabled vlans add { gwlb-internal-tun } translate-address disabled source-port preserve-strict pool external-tunnel-pool\n\nRepeat the previous Deploy BIG-IP Virtual Machine steps, to deploy more BIG-IPs and add them to the Gateway Load Balancer pool. F5 recommends automating this process. For example, see F5 DevCentral.\n\nAzure CLI summaryÂ¶\n\n#!/bin/bash ### CREATE RESOURCE GROUP az group create --name example-rg -l eastus ### CREATE NETWORK AND SUBNETS az network vnet create --name example-vnet -g example-rg -l eastus --address-prefixes 10.0.0.0/16 az network vnet subnet create --name management -g example-rg --vnet-name example-vnet --address-prefixes 10.0.0.0/24 az network vnet subnet create --name external -g example-rg --vnet-name example-vnet --address-prefixes 10.0.1.0/24 az network vnet subnet create --name internal -g example-rg --vnet-name example-vnet --address-prefixes 10.0.2.0/24 az network vnet subnet create --name application -g example-rg --vnet-name example-vnet --address-prefixes 10.0.3.0/24 ### CREATE NETWORK SECURITY GROUPS # Management Security Group az network nsg create --name management-nsg -g example-rg -l eastus az network nsg rule create --name allow-22 -g example-rg --nsg-name management-nsg --priority 101 --access Allow --description 'allow port 22' --destination-port-ranges 22 --protocol Tcp --source-address-prefixes \"10.0.0.0/16\" az network nsg rule create --name allow-443 -g example-rg --nsg-name management-nsg --priority 102 --access Allow --description 'allow port 443' --destination-port-ranges 443 --protocol Tcp --source-address-prefixes \"10.0.0.0/16\" # External Security Group az network nsg create --name external-nsg -g example-rg -l eastus # Gateway Traffic az network nsg rule create --name allow-2000-udp -g example-rg --nsg-name external-nsg --priority 101 --access Allow --description 'allow vxlan on udp port 2000' --destination-port-ranges 2000 --protocol Udp --source-address-prefixes \"*\" az network nsg rule create --name allow-2001-udp -g example-rg --nsg-name external-nsg --priority 102 --access Allow --description 'allow vxlan on udp port 2001' --destination-port-ranges 2001 --protocol Udp --source-address-prefixes \"*\" az network nsg rule create --name allow-24500 -g example-rg --nsg-name external-nsg --priority 103 --access Allow --description 'allow gw health probe on tcp port 24500 ' --destination-port-ranges 24500 --protocol Tcp --source-address-prefixes \"*\" # Clustering az network nsg rule create --name allow-failover -g example-rg --nsg-name internal-nsg --priority 101 --access Allow --description 'allow udp port 1026' --destination-port-ranges 1026 --protocol Udp --source-address-prefixes \"10.0.0.0/16\" az network nsg rule create --name allow-config-sync -g example-rg --nsg-name internal-nsg --priority 102 --access Allow --description 'allow tcp port 4353' --destination-port-ranges 4353 --protocol Tcp --source-address-prefixes \"10.0.0.0/16\" az network nsg rule create --name allow-config-sync-asm -g example-rg --nsg-name internal-nsg --priority 103 --access Allow --description 'allow tcp port 6123-6128' --destination-port-ranges '6123-6128' --protocol Tcp --source-address-prefixes \"10.0.0.0/16\" ### CREATE NICS # Public IP az network public-ip create --name management-public-ip -g example-rg --allocation-method Static # Management NIC az network nic create --name management-nic -g example-rg --vnet-name example-vnet --subnet management --ip-forwarding --network-security-group management-nsg --private-ip-address 10.0.0.11 --public-ip-address management-public-ip # External NIC az network nic create --name external-nic -g example-rg --vnet-name example-vnet --subnet external --ip-forwarding --private-ip-address 10.0.1.11 --network-security-group external-nsg # Internal NIC az network nic create --name internal-nic -g example-rg --vnet-name example-vnet --subnet internal --ip-forwarding --private-ip-address 10.0.2.11 --network-security-group internal-nsg ### CREATE VIRTUAL MACHINE az vm create --name BIGIP-vm -g example-rg \\ --image f5-networks:f5-big-ip-best:f5-bigip-virtual-edition-25m-best-hourly:16.0.101000 \\ --size Standard_DS3_v2 \\ --nics management-nic external-nic \\ --admin-username azureuser \\ --ssh-key-values \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQClW+UyY2eWczwnEGcEtwR/ISURqmdQIpgicgVvUvZTilXYâ¦.\" ### CREATE GWLB # Create GWLB az network lb create --name example-gwlb --sku Gateway -g example-rg --vnet-name example-vnet --subnet external --frontend-ip-name example-gwlb-frontend-ip --backend-pool-name example-backend-pool # Create Backend Pool az network lb address-pool tunnel-interface add -g example-rg --lb-name example-gwlb --address-pool example-backend-pool --type external --protocol vxlan --identifier 801 --port 2001 az network lb address-pool tunnel-interface update -g example-rg --lb-name example-gwlb --address-pool example-backend-pool --index 0 --type internal --protocol vxlan --identifier 802 --port 2002 # Create Health Probe az network lb probe create --name example-health-probe -g example-rg --lb-name example-gwlb --protocol http --port 24500 --path /healthcheck # Create LB Rules az network lb rule create --name example-lb-rule --lb-name example-gwlb -g example-rg --protocol all --frontend-port 0 --backend-port 0 --frontend-ip-name example-gwlb-frontend-ip --backend-pool-name example-backend-pool --probe-name example-health-probe --disable-outbound-snat true # Add BIG-IP to Backend Pool az network lb address-pool address add -n bigip-vm-address --ip-address 10.0.1.11 -g example-rg --lb-name example-gwlb --pool-name example-backend-pool --vnet example-vnet\n\nBIG-IP TMSH CLI summaryÂ¶\n\n# TMSH Commands tmsh create net vlan external interfaces add { 1.1 } mtu 9001 tmsh create net self external-self address 10.0.1.11/24 vlan external allow-service all # Gateway LB Specific Config tmsh create net tunnels vxlan gwlb-ext-vxlan-prof port 2001 flooding-type none tmsh create net tunnels vxlan gwlb-int-vxlan-prof port 2002 flooding-type none tmsh create net tunnels tunnel gwlb-external-tun key 801 profile gwlb-ext-vxlan-prof local-address 10.0.1.11 remote-address any tmsh create net tunnels tunnel gwlb-internal-tun key 802 profile gwlb-int-vxlan-prof local-address 10.0.1.11 remote-address any tmsh create net vlan-group vg-1 members add { gwlb-external-tun } tmsh create net vlan-group vg-2 members add { gwlb-internal-tun } bridge-traffic enabled tmsh create net self vxlan-external-self address 192.168.1.11/28 vlan vg-1 allow-service all tmsh create net self vxlan-internal-self address 192.168.2.11/28 vlan vg-2 allow-service all tmsh create net arp static-arp-entry-external ip-address 192.168.1.1 mac-address ff:ff:ff:ff:ff:aa tmsh create net arp static-arp-entry-internal ip-address 192.168.2.1 mac-address ff:ff:ff:ff:ff:bb GATEWAY_ADDRESS=10.0.1.4; GATEWAY_MAC=$(arping -I external -c 1 $GATEWAY_ADDRESS | egrep -o '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}'); tmsh modify net fdb tunnel gwlb-external-tun records add { $GATEWAY_MAC { description gwlb endpoint $GATEWAY_ADDRESS } }; tmsh modify net fdb tunnel gwlb-internal-tun records add { ff:ff:ff:ff:ff:bb { description gwlb endpoint $GATEWAY_ADDRESS } } # Create Virtual Service to answer GWLB Health Probe tmsh create ltm rule /Common/http-server when HTTP_REQUEST { HTTP::respond 200 \\'System Responding\\'} tmsh create ltm virtual gwlb-health-probe-vs destination 0.0.0.0:24500 mask 0.0.0.0 ip-protocol tcp profiles add { http tcp } vlans-enabled vlans add { external } rules { http-server } # Create Virtual Service to process Incoming Tunnel Traffic tmsh create ltm node internal-tunnel-node address 192.168.2.1 monitor none tmsh create ltm pool internal-tunnel-pool members add { internal-tunnel-node:0 } monitor none create ltm virtual ingress-vs-http destination 0.0.0.0:80 mask any ip-protocol tcp profiles add { f5-tcp-wan { context clientside } f5-tcp-lan { context serverside } http } vlans-enabled vlans add { gwlb-external-tun } translate-address disabled source-port preserve-strict pool internal-tunnel-pool # Create Virtual Service to process Outgoing Tunnel Traffic tmsh create ltm node external-tunnel-node address 192.168.1.1 monitor none tmsh create ltm pool external-tunnel-pool members add { external-tunnel-node:0 } monitor none tmsh create ltm virtual egress-vs-http destination 0.0.0.0:80 mask any ip-protocol any vlans-enabled vlans add { gwlb-internal-tun } translate-address disabled source-port preserve-strict pool external-tunnel-pool tmsh save /sys config\n\nMore help\n\nBIG-IP Multi-NIC in Azure\n\nGateway Load Balancer\n\nSKUs\n\nGWLB Blog\n\nAzure Multi-NIC\n\nAzure Create Linux Virtual Machine\n\nF5 BIG-IP Azure Gateway Load Balancer Terraform Example\n\nF5 BIG-IP Terraform Module\n\nF5 BIG-IP Azure ARM Template Modules\n\nF5 BIG-IP Web Application Firewall\n\nApplication Services\n\nF5Â® BIG-IPÂ® Telemetry Streaming"
    }
}