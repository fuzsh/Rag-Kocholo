{
    "id": "wrong_mix_domainrange_subsidiary_00147_1",
    "rank": 80,
    "data": {
        "url": "https://www.ferroquesystems.com/resource/howto-one-vdisk-multiple-environments-and-force-gpupdate-at-startup/",
        "read_more_link": "",
        "language": "en",
        "title": "HowTo: One vDisk, Multiple Environments and Force GPUPDATE at Startup",
        "top_image": "https://www.ferroquesystems.com/wp-content/uploads/2018/11/pvs-vdisk-multiple-environments.webp",
        "meta_img": "https://www.ferroquesystems.com/wp-content/uploads/2018/11/pvs-vdisk-multiple-environments.webp",
        "images": [
            "https://www.ferroquesystems.com/wp-content/uploads/2023/11/logo-ferroque-systems.svg",
            "https://www.ferroquesystems.com/wp-content/uploads/2023/11/logo-ferroque-systems-white.svg",
            "https://www.ferroquesystems.com/wp-content/uploads/2023/11/logo-ferroque-systems.svg",
            "https://www.ferroquesystems.com/wp-content/uploads/2023/11/logo-ferroque-systems-white.svg",
            "https://www.ferroquesystems.com/wp-content/uploads/2023/11/icons8-user_account.svg",
            "https://www.ferroquesystems.com/wp-content/uploads/2024/03/icons8-multiple_devices.svg",
            "https://www.ferroquesystems.com/wp-content/uploads/2024/04/icons8-learning.svg",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/d3/transparent-d345fe32.png",
            "https://www.ferroquesystems.com/wp-content/uploads/2018/11/vda_reg_gpo.png",
            "https://www.ferroquesystems.com/wp-content/uploads/2018/11/gpo_script1.png",
            "https://www.ferroquesystems.com/wp-content/uploads/2018/11/gpo_script2.png",
            "https://www.ferroquesystems.com/wp-content/uploads/2024/02/headshot-michael-shuster.jpg",
            "https://secure.gravatar.com/avatar/b1dce40b29d38748d003ef17ed74977d?s=56&d=mm&r=g",
            "https://secure.gravatar.com/avatar/ee0cdc330a9b770604974185ca290fc7?s=56&d=mm&r=g",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/45/netscaler_dtls1.2_citrix-45a60cb7.webp",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/b2/fido2_hero-b2cfafd5.webp",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/f9/citrix_optimal_sta_config_hero_altv2-f96ee499.webp",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/bc/ceb_spa_browser-bc2410f9.jpeg",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/ab/Citrix-VIsio-Stencils-Ferroque-ab47c45e.jpeg",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/98/netscaler_dtls1.2_citrix-98a4d90b.webp",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/53/fido2_hero-5316f6af.webp",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/75/citrix_optimal_sta_config_hero_altv2-75328073.webp",
            "https://www.ferroquesystems.com/wp-content/themes/yootheme/cache/e8/ceb_spa_browser-e8b95867.jpeg",
            "https://www.ferroquesystems.com/wp-content/uploads/2023/11/logo-ferroque-systems-white.svg",
            "https://px.ads.linkedin.com/collect/?pid=1812122&fmt=gif"
        ],
        "movies": [],
        "keywords": [],
        "meta_keywords": [
            ""
        ],
        "tags": null,
        "authors": [],
        "publish_date": "2018-11-02T17:16:29+00:00",
        "summary": "",
        "meta_description": "This post is intended to solve two challenges: I have a vDisk I need to use in multiple Citrix environments (different Delivery Controllers) and do not require customization of apps between environments (apps configured to go to different backends, etc.). I do not want to have to maintain one vDisk per environment just to change […]",
        "meta_lang": "en",
        "meta_favicon": "/wp-content/uploads/2023/11/favicon.png",
        "meta_site_name": "Ferroque Systems",
        "canonical_link": "https://www.ferroquesystems.com/resource/howto-one-vdisk-multiple-environments-and-force-gpupdate-at-startup/",
        "text": "This post is intended to solve two challenges:\n\nI have a vDisk I need to use in multiple Citrix environments (different Delivery Controllers) and do not require customization of apps between environments (apps configured to go to different backends, etc.). I do not want to have to maintain one vDisk per environment just to change VDA registration params.\n\nI want to ensure that on startup, my target devices refresh their GPO computer policies, as we generally can’t rely on AD to refresh GPOs immediately on boot-up.\n\n1 and 2 go hand in hand for reliable application of VDA registration settings. VDA registration can be applied in a 7.x environment in numerous ways; directly on the VDA configuration within the image, via ListOfDDCs registry params, HDX policies (in studio or AD GPO), etc. When dealing with single environment platforms, I typically just configure the VDAs with their Delivery Controllers locally within the image. If there are multiple environments (NonProd, DR, Prod, etc) that can leverage the same image and it’ll remain relatively static between them, it’s much easier to maintain one vDisk for all environments vs. configuring updates for each of them independently.\n\nIn my experience the simplest means to do this has been to configure an HDX policy within an AD GPO, that sets the VDA registration parameters. Doing this via GPO gives us the flexibility to tie the GPO to appropriate OU structures, and allows us to ensure the settings are applied correctly. Ensuring at boot-up a computer refreshes their GPOs helps here to ensure a VDA registers with the correct controllers for its respective environment, based on machine to OU association.\n\nStep 1 – Create a GPO Per Environment for VDA Registration\n\nI find it easiest to install GPMC on your Delivery Controllers, then edit the new GPO(s) created per environment, which should be labelled accordingly (indicating environment, and VDAReg GPO, can also add other settings in here like WEM controllers etc). This will ensure the Citrix GPO extensions are visible. These settings for HDX policies will otherwise not be visible on say, a Domain Controller without the Citrix GPO extensions installed on that Domain Controller so the settings become visible in GPMC locally on that computer.\n\nI edit the unfiltered policy for Computer settings, and for the ‘Controllers’ settings specify the Delivery Controllers for the given site. That is usually all I’ve had to do. In some instances I have had to disable in this policy auto-update of controllers as it was interfering with operations.\n\nLink the GPO to the OU(s) containing the VDAs for the given site.\n\nStep 2 – GPUDATE Script\n\nThis step involves creating a script that will be set to run at startup. Some things to watch for in its creation. If you have a single environment and just want GPUPDATE to run at startup to avoid opening up images in private or maintenance mode to cache new GPU computer settings updates for a consistent experience, you can follow these steps but omit and line items to start and stop services.\n\nBe mindful of course, of impacts of GPUPDATE. If the environment size is comprised of a few dozen systems that might reboot at once, it is a negligible consideration. In large enterprise environments with hundreds of VDAs that might happen to reboot simultaneously, just be mindful that a GPUPDATE /FORCE (which is more intensive in its operations than plain GPUPDATE) will put some added load on your Domain Controllers to which the VDAs are associated with in your AD Sites & Services setup. I haven’t had this arise as a real concern, just good to be aware of.\n\nIn an existing Baseline Computers GPO for your VDAs, or even in your VDAReg GPO you created, we’ll be adding a batch file.\n\nEdit the GPO, go to Computer Configuration > Windows Settings > Scripts > Startup\n\nClick ‘Show Files’, which opens up a file explorer window. Here you’ll add a batch file containing the following contents:\n\ngpupdate /force net stop brokeragent net start brokeragent exit\n\nWhat this essentially does is run a GPUPDATE at boot, stop the VDA Broker Agent, and start it, to ensure it reads the refreshed VDA registration settings. If you do not need to manage VDA registration settings (single environment) then omit the net commands.\n\nWords to the wise:\n\nDo NOT name the script “gpupdate”, it will cause loops as its also the name of a command in the file.\n\nDo NOT save this as .cmd file, save it as a .bat. This will also cause loops. In both cases the experience of the loop will be the VDA service starting and stopping immediately, likely logging 1003 event ID errors in the event logs.\n\nMove the batch file into the folder opened from ‘Show Files…’.\n\nThen just click the “Add…” button and select the file just added.\n\nShould be good to go, test it out rebooting a VDA in the OU to which the VDAReg GPO is applied to, you should see in the logs that post reboot the Broker Agent stops then restarts again."
    }
}