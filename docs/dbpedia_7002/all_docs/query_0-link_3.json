{
    "id": "dbpedia_7002_0",
    "rank": 3,
    "data": {
        "url": "https://arxiv.org/html/2406.13934v1",
        "read_more_link": "",
        "language": "en",
        "title": "Reasoning Like a Doctor: Improving Medical Dialogue Systems via Diagnostic Reasoning Process Alignment",
        "top_image": "",
        "meta_img": "",
        "images": [
            "https://arxiv.org/html/x1.png",
            "https://arxiv.org/html/x2.png",
            "https://arxiv.org/html/x3.png",
            "https://arxiv.org/html/x4.png",
            "https://arxiv.org/html/x5.png",
            "https://arxiv.org/html/x6.png",
            "https://arxiv.org/html/x7.png",
            "https://arxiv.org/html/x8.png",
            "https://arxiv.org/html/x9.png",
            "https://arxiv.org/html/x10.png",
            "https://arxiv.org/html/x11.png",
            "https://arxiv.org/html/x12.png",
            "https://arxiv.org/html/x13.png",
            "https://arxiv.org/html/x14.png"
        ],
        "movies": [],
        "keywords": [],
        "meta_keywords": [
            ""
        ],
        "tags": null,
        "authors": [],
        "publish_date": null,
        "summary": "",
        "meta_description": "",
        "meta_lang": "en",
        "meta_favicon": "",
        "meta_site_name": "",
        "canonical_link": null,
        "text": "Kaishuai Xu1, Yi Cheng1∗, Wenjun Hou1,2∗, Qiaoyu Tan3, Wenjie Li1\n\n1The Hong Kong Polytechnic University, HKSAR, China\n\n2Southern University of Science and Technology, Shenzhen, China\n\n3New York University Shanghai, Shanghai, China\n\n{kaishuaii.xu, alyssa.cheng}@connect.polyu.hk, houwenjun060@gmail.com\n\nqiaoyu.tan@nyu.edu, cswjli@comp.polyu.edu.hk\n\nAbstract\n\nMedical dialogue systems have attracted significant attention for their potential to act as medical assistants. Enabling these medical systems to emulate clinicians’ diagnostic reasoning process has been the long-standing research focus. Previous studies rudimentarily realized the simulation of clinicians’ diagnostic process by fine-tuning language models on high-quality dialogue datasets. Nonetheless, they overly focus on the outcomes of the clinician’s reasoning process while ignoring their internal thought processes and alignment with clinician preferences. Our work aims to build a medical dialogue system that aligns with clinicians’ diagnostic reasoning processes. We propose a novel framework, Emulation, designed to generate an appropriate response that relies on abductive and deductive diagnostic reasoning analyses and aligns with clinician preferences through thought process modeling. Experimental results on two datasets confirm the efficacy of Emulation. Crucially, our framework furnishes clear explanations for the generated responses, enhancing its transparency in medical consultations.\n\n1 Introduction\n\nMedical dialogue systems as a fundamental tool in facilitating effective healthcare consultations have garnered sustained attention in recent years Zeng et al. (2020); Liu et al. (2022b). Especially with the rise of large language models (LLMs), these systems have shown promising potential to act as virtual medical assistants that can aid clinicians in accurate and efficient diagnosis Bao et al. (2023); Chen et al. (2023); OpenAI (2023). In this research area, how to enable these medical systems to emulate clinicians’ diagnostic reasoning process has been the long-standing research focus ever since its inception Holyoak and Morrison (2005). To achieve this, previous research has paid tremendous efforts in constructing high-quality datasets of medical consultation dialogues, based on which they fine-tuned language models, rudimentarily realizing the simulation of clinicians’ diagnostic process that can inquire about symptoms and make a diagnosis Bao et al. (2023); Chen et al. (2023); Liu et al. (2022b); Xu et al. (2023).\n\nNonetheless, existing research remains focused on the “output” of the clinician’s reasoning process (e.g., the symptoms and diseases mentioned in clinicians’ utterances), still neglecting the clinician’s internal thought process and decision-making mechanisms. As a result, available systems overly rely on the co-occurrence patterns in the training data, prone to inquire about the most frequent symptoms and diagnose the most common disease. In fact, a real clinician’s thought process goes far beyond this. In clinical medicine, there is a concept known as “Clinician Preference” Silverman et al. (2016); Holyoak and Morrison (2005); Murray et al. (2007). It refers to the inclinations that healthcare professionals exhibit during diagnostic reasoning. It has been widely acknowledged that clinician preferences are affected by many factors Silverman et al. (2016), much more than the symptom and disease frequency. For example, in Figure 1, the clinician prefers to discuss examinations in the next response to rule out colitis rather than consider factors that cause irritable bowel syndrome. This is because the location of the discomfort typically indicates a more severe issue in the colon. For the existing systems that are constructed purely through dialogue data fine-tuning, it is difficult to capture such subtle reasoning preferences Xiong et al. (2023).\n\nIn this paper, we aim to develop a medical dialogue system that can align with the internal diagnostic reasoning process of clinicians. To this end, we must first model a diagnostic analysis process. For the multi-turn medical dialogue, clinicians generally adopt an iterative, abductive, and deductive analysis that discovers an explanation of the patient’s condition and evaluates the effectiveness of the explanation Holyoak and Morrison (2005). This analysis provides a robust and comprehensive foundation for accurate diagnoses. Then, we need to align response generation with the clinician preference based on the analysis and dialogue context. The thought process of how clinicians reason and generate responses is a vital resource for learning their preferences. Extracting the thought process and modeling it together with responses can help learn the diagnostic reasoning process.\n\nBased on the above motivation, we propose a novel medical dialogue system framework, Emulation, which emulates clinicians’ diagnostic reasoning processes to generate an appropriate response that relies on ample diagnostic analysis and aligns with clinician preferences in consultation. First, an abductive reasoning module investigates potential diseases that can explain a patient’s condition. Then, a deductive reasoning module comprehensively analyzes the relation between clinical findings and potential diseases. Finally, the thought alignment module adjusts the potential disease priority that may be discussed next and generates thought processes that align with the clinician preference based on the above analysis. To learn the clinician preference, we build a new diagnostic thought process dataset with the help of an LLM.\n\nOur key contributions are outlined as follows: (1) We propose a novel medical dialogue system framework, Emulation, that emulates clinicians’ diagnostic reasoning processes and aligns with clinician preferences. This is the first work that explores clinician preferences and internal thought processes. (2) We build a diagnostic thought process dataset that is employed to align response generation with clinician preferences. (3) Experimental results demonstrate the effectiveness and explainability of Emulation.\n\n2 Preliminary\n\n2.1 Problem Formulation\n\nIn our work, we conceptualize a medical dialogue as a sequence U={(UkP,UkD)}k=1T𝑈superscriptsubscriptsubscriptsuperscript𝑈𝑃𝑘subscriptsuperscript𝑈𝐷𝑘𝑘1𝑇U=\\{(U^{P}_{k},U^{D}_{k})\\}_{k=1}^{T}italic_U = { ( italic_U start_POSTSUPERSCRIPT italic_P end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT , italic_U start_POSTSUPERSCRIPT italic_D end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT ) } start_POSTSUBSCRIPT italic_k = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_T end_POSTSUPERSCRIPT, where each pair (UkP,UkD)subscriptsuperscript𝑈𝑃𝑘subscriptsuperscript𝑈𝐷𝑘(U^{P}_{k},U^{D}_{k})( italic_U start_POSTSUPERSCRIPT italic_P end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT , italic_U start_POSTSUPERSCRIPT italic_D end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT ) comprises an utterance from a patient followed by an utterance from a doctor. Each doctor’s utterance is annotated with a list of diseases Et={ei}subscript𝐸𝑡subscript𝑒𝑖E_{t}=\\{e_{i}\\}italic_E start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT = { italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT } that could be relevant to the patient’s condition mentioned in the dialogue. Given a dialogue history Ut={U1P,U1D,…,UtP}subscript𝑈𝑡subscriptsuperscript𝑈𝑃1subscriptsuperscript𝑈𝐷1…subscriptsuperscript𝑈𝑃𝑡U_{t}=\\{U^{P}_{1},U^{D}_{1},...,U^{P}_{t}\\}italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT = { italic_U start_POSTSUPERSCRIPT italic_P end_POSTSUPERSCRIPT start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , italic_U start_POSTSUPERSCRIPT italic_D end_POSTSUPERSCRIPT start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , … , italic_U start_POSTSUPERSCRIPT italic_P end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT } up to the t𝑡titalic_t-th patient utterance, our system’s objective is to generate a contextually appropriate and medically informed t𝑡titalic_t-th doctor’s utterance UtDsubscriptsuperscript𝑈𝐷𝑡U^{D}_{t}italic_U start_POSTSUPERSCRIPT italic_D end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT.\n\n2.2 Diagnostic Reasoning\n\nDiagnostic reasoning involves a detailed examination of how doctors think and make decisions in medicine Holyoak and Morrison (2005). It serves as a foundational element for advanced cognitive activities, such as formulating diagnostic conclusions and grasping the underlying pathology of diseases. The framework of diagnostic reasoning has been a focal point of medical cognition research Patel and Ramoni (1997). A widely recognized perspective holds that diagnosis represents an iterative, abductive, and deductive process of formulating and evaluating potential explanations for a patient’s abnormal condition Elstein et al. (1978); Holyoak and Morrison (2005). We summarize this perspective into two reasoning processes: Abductive Reasoning aims to create a plausible diagnosis to explain observed clinical findings; Deductive Reasoning further tests the available diagnoses by determining whether the findings support, refute, or are unrelated to the diagnoses. In our method, the first process efficiently explores a disease knowledge base to identify several possible diseases that explain the patient’s condition in the current turn of the conversation. The second process comprehensively inspects the relationship between the clinical findings and possible diseases. These two processes are conducted iteratively across the conversation. Besides, the clinician preference for medical decision analysis plays an essential role in the diagnostic reasoning process Silverman et al. (2016). This preference highlights behaviors and actions in medical conversations unique to each clinician, which LLMs may lack. It is the nuanced preference difference that distinguishes a superior clinician from other clinicians Yu et al. (2024). We model a Thought Alignment process to align response generation with the general clinician preference in consultation.\n\n2.3 Disease Annotation\n\nGiven GPT-4’s demonstrated effectiveness in several medical licensing examinations OpenAI (2023), we employ it to annotate potential diseases relevant to the patient’s condition automatically. We implement two ways to generate lists of diseases considered before and after examining the current doctor’s response. For the first list, we construct a prompt with the dialogue history Utsubscript𝑈𝑡U_{t}italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT, utilizing the model’s diagnostic skills to identify potential diseases. For the second list, we create a prompt that incorporates both the history Utsubscript𝑈𝑡U_{t}italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT and the ground truth response UtDsubscriptsuperscript𝑈𝐷𝑡U^{D}_{t}italic_U start_POSTSUPERSCRIPT italic_D end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT, enabling the model to deduce the diseases that doctors might discuss. Then, we link the inferred diseases with those in an external medical knowledge base and obtain two lists of potential diseases, Etp⁢r⁢isubscriptsuperscript𝐸𝑝𝑟𝑖𝑡E^{pri}_{t}italic_E start_POSTSUPERSCRIPT italic_p italic_r italic_i end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT and Etp⁢o⁢s⁢tsubscriptsuperscript𝐸𝑝𝑜𝑠𝑡𝑡E^{post}_{t}italic_E start_POSTSUPERSCRIPT italic_p italic_o italic_s italic_t end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT. We merge two lists as one Etsubscript𝐸𝑡E_{t}italic_E start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT for each doctor’s response. The details are described in the Appendix A.2.\n\n3 Method\n\nIn this section, we introduce a diagnostic reasoning framework, which analyzes patient conditions through abductive reasoning and deductive reasoning Holyoak and Morrison (2005), and aligns responses with the clinician preferences. As shown in Figure 2, our framework includes three modules. The Abductive Reasoner (§3.1) first generates potential diseases based on the new clinical findings of each turn. Then, the Deductive Reasoner (§3.2) comprehensively analyzes the relation between potential diseases and new clinical findings. Finally, the Thought Alignment (§3.3) module adjusts the disease priority that might be discussed in subsequent dialogues and performs thought process modeling to generate the next response.\n\nGiven the medical dialogue history Utsubscript𝑈𝑡U_{t}italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT at the t𝑡titalic_t-th conversation turn, we first use a pre-trained LLM to summarize new clinical findings from the recent utterances Ut−1Dsubscriptsuperscript𝑈𝐷𝑡1U^{D}_{t-1}italic_U start_POSTSUPERSCRIPT italic_D end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t - 1 end_POSTSUBSCRIPT and UtPsubscriptsuperscript𝑈𝑃𝑡U^{P}_{t}italic_U start_POSTSUPERSCRIPT italic_P end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT. The clinical findings are presented using the SOAP note Cameron and Turtle-Song (2002), a documentation technique utilized by healthcare professionals for recording notes (e.g., chief complaint) in a patient’s medical record. For example, we provide the LLM with a prompt to “summarize the clinical findings from the recent conversation between doctor and patient, adhering to the structure of the SOAP note”. Each of the summarized clinical findings is in the phrase format and merged into a set St={sj}j=1msubscript𝑆𝑡superscriptsubscriptsubscript𝑠𝑗𝑗1𝑚S_{t}=\\{s_{j}\\}_{j=1}^{m}italic_S start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT = { italic_s start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT } start_POSTSUBSCRIPT italic_j = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_m end_POSTSUPERSCRIPT, where m𝑚mitalic_m represents the number of clinical findings at the t𝑡titalic_t-th conversation turn.\n\n3.1 Abductive Reasoner\n\nThe Abductive Reasoner aims to find the most possible diseases that explain the patient’s abnormal condition. Previous studies rely solely on the diagnosis capability of black-box language models or focus on limited diseases in one dataset. We design a two-step pipeline to achieve a comprehensive and explainable abduction. The first step employs a disease retriever to narrow down the scope of the disease. Then, the second step leverages a pre-trained LLM to generate a potential disease list with detailed explanations based on the clinical findings and external medical knowledge.\n\nDisease Retrieval.\n\nWe concatenate all findings as the query and retrieve disease documents that are relevant to the findings from an external medical knowledge base. A dense retriever with a BERT encoder is applied to collect relevant documents. The sequences of the query and disease document, each prefixed with a “[CLS]” token, are fed independently into the encoder. The hidden state corresponding to the “[CLS]” token from each sequence is chosen to serve as their respective representations 𝐡∈ℝd𝐡superscriptℝ𝑑\\mathbf{h}\\in\\mathbb{R}^{d}bold_h ∈ blackboard_R start_POSTSUPERSCRIPT italic_d end_POSTSUPERSCRIPT and 𝐡d⁢o⁢c∈ℝdsubscript𝐡𝑑𝑜𝑐superscriptℝ𝑑\\mathbf{h}_{doc}\\in\\mathbb{R}^{d}bold_h start_POSTSUBSCRIPT italic_d italic_o italic_c end_POSTSUBSCRIPT ∈ blackboard_R start_POSTSUPERSCRIPT italic_d end_POSTSUPERSCRIPT. We compute relevance scores through dot product as 𝐡𝖳⋅𝐡d⁢o⁢c⋅superscript𝐡𝖳subscript𝐡𝑑𝑜𝑐\\mathbf{h}^{\\mathsf{T}}\\cdot\\mathbf{h}_{doc}bold_h start_POSTSUPERSCRIPT sansserif_T end_POSTSUPERSCRIPT ⋅ bold_h start_POSTSUBSCRIPT italic_d italic_o italic_c end_POSTSUBSCRIPT. The diseases corresponding to the top-K𝐾Kitalic_K documents ranked by the scores are considered candidate diseases E^t0={ei}i=1Ksuperscriptsubscript^𝐸𝑡0superscriptsubscriptsubscript𝑒𝑖𝑖1𝐾{\\hat{E}_{t}}^{0}=\\{e_{i}\\}_{i=1}^{K}over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT 0 end_POSTSUPERSCRIPT = { italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT } start_POSTSUBSCRIPT italic_i = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_K end_POSTSUPERSCRIPT. Our approach utilizes Contrastive Learning Gao et al. (2021) to train the retrieval model. The loss function applied to the training is specified as follows:\n\nℒCL=subscriptℒCLabsent\\displaystyle{\\cal{L}}_{\\text{CL}}=caligraphic_L start_POSTSUBSCRIPT CL end_POSTSUBSCRIPT = −log⁡exp⁡(𝐡𝖳⋅𝐡d⁢o⁢c+)exp⁡(𝐡𝖳⋅𝐡d⁢o⁢c+)+∑𝒞exp⁡(𝐡𝖳⋅𝐡d⁢o⁢c−),⋅superscript𝐡𝖳superscriptsubscript𝐡𝑑𝑜𝑐⋅superscript𝐡𝖳superscriptsubscript𝐡𝑑𝑜𝑐subscript𝒞⋅superscript𝐡𝖳superscriptsubscript𝐡𝑑𝑜𝑐\\displaystyle-\\log\\frac{\\exp\\left(\\mathbf{h}^{\\mathsf{T}}\\!\\cdot\\!\\mathbf{h}_{% doc}^{+}\\right)}{\\exp\\left(\\mathbf{h}^{\\mathsf{T}}\\!\\cdot\\!\\mathbf{h}_{doc}^{+% }\\right)\\!+\\!\\mathop{\\sum}\\limits_{\\mathcal{C}}\\exp\\left(\\mathbf{h}^{\\mathsf{T% }}\\!\\cdot\\!\\mathbf{h}_{doc}^{-}\\right)},- roman_log divide start_ARG roman_exp ( bold_h start_POSTSUPERSCRIPT sansserif_T end_POSTSUPERSCRIPT ⋅ bold_h start_POSTSUBSCRIPT italic_d italic_o italic_c end_POSTSUBSCRIPT start_POSTSUPERSCRIPT + end_POSTSUPERSCRIPT ) end_ARG start_ARG roman_exp ( bold_h start_POSTSUPERSCRIPT sansserif_T end_POSTSUPERSCRIPT ⋅ bold_h start_POSTSUBSCRIPT italic_d italic_o italic_c end_POSTSUBSCRIPT start_POSTSUPERSCRIPT + end_POSTSUPERSCRIPT ) + ∑ start_POSTSUBSCRIPT caligraphic_C end_POSTSUBSCRIPT roman_exp ( bold_h start_POSTSUPERSCRIPT sansserif_T end_POSTSUPERSCRIPT ⋅ bold_h start_POSTSUBSCRIPT italic_d italic_o italic_c end_POSTSUBSCRIPT start_POSTSUPERSCRIPT - end_POSTSUPERSCRIPT ) end_ARG , (1)\n\nwhere 𝐡d⁢o⁢c+superscriptsubscript𝐡𝑑𝑜𝑐\\mathbf{h}_{doc}^{+}bold_h start_POSTSUBSCRIPT italic_d italic_o italic_c end_POSTSUBSCRIPT start_POSTSUPERSCRIPT + end_POSTSUPERSCRIPT and 𝐡d⁢o⁢c−superscriptsubscript𝐡𝑑𝑜𝑐\\mathbf{h}_{doc}^{-}bold_h start_POSTSUBSCRIPT italic_d italic_o italic_c end_POSTSUBSCRIPT start_POSTSUPERSCRIPT - end_POSTSUPERSCRIPT denotes document representations of the relevant diseases in this turn Etsubscript𝐸𝑡E_{t}italic_E start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT and the irrelevant ones in the knowledge base 𝒞𝒞\\mathcal{C}caligraphic_C. We adopt in-batch negative sampling for training.\n\nDiagnosis Refinement.\n\nAfter the retrieval, we have assembled a list of potential diseases; however, this approach unavoidably results in the inclusion of diseases irrelevant to the patient’s condition. Furthermore, the disease retrieval, based on vector similarity, can not elucidate the rationale behind the presence of specific diseases within the potential list. In pursuit of an explainable diagnosis, we utilize a pre-trained LLM to identify possible diseases from this list, offering an explanation grounded in clinical findings. The diagnosis knowledge of each disease is provided since it can appropriately reduce the hallucination issue of LLMs. For instance, we prompt the LLM with “given the findings and knowledge, select possible diseases that can explain the new clinical findings while satisfying past findings”. To achieve a stable disease identification, we adopt a majority vote inspired by Wang et al. (2023). Specifically, we randomly divide the list into batches of the same size (since the maximum input tokens of LLMs limit the diseases and knowledge that can be input). Such division is repeated several times to construct different batch groups. We utilize batch groups to generate several refined disease lists and calculate the voting score of each disease as follows:\n\nv⁢(ei)=∑j=1B𝟙⁢(ei∈E^tj),ei∈E^t0,formulae-sequence𝑣subscript𝑒𝑖superscriptsubscript𝑗1𝐵1subscript𝑒𝑖superscriptsubscript^𝐸𝑡𝑗subscript𝑒𝑖superscriptsubscript^𝐸𝑡0v(e_{i})=\\sum_{j=1}^{B}\\mathbbm{1}(e_{i}\\in{\\hat{E}_{t}}^{j}),e_{i}\\in{\\hat{E}% _{t}}^{0},italic_v ( italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ) = ∑ start_POSTSUBSCRIPT italic_j = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_B end_POSTSUPERSCRIPT blackboard_1 ( italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ∈ over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_j end_POSTSUPERSCRIPT ) , italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ∈ over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT 0 end_POSTSUPERSCRIPT , (2)\n\nwhere B𝐵Bitalic_B stands for the number of batch groups, and E^tjsuperscriptsubscript^𝐸𝑡𝑗{\\hat{E}_{t}}^{j}over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_j end_POSTSUPERSCRIPT represents the j𝑗jitalic_j-th refined list. The final refined list includes diseases with a voting score exceeding B/2𝐵2B/2italic_B / 2, denoted as E^t′={ei}i=1K′superscriptsubscript^𝐸𝑡′superscriptsubscriptsubscript𝑒𝑖𝑖1superscript𝐾′{\\hat{E}_{t}}^{\\prime}=\\{e_{i}\\}_{i=1}^{K^{\\prime}}over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT = { italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT } start_POSTSUBSCRIPT italic_i = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_K start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT end_POSTSUPERSCRIPT.\n\n3.2 Deductive Reasoner\n\nWhile the Abductive Reasoner has offered an analysis of the relationship between potential diseases and new clinical findings, this analysis predominantly aims to confirm a disease rather than exclude one or sift through information irrelevant to the current diagnosis. It is crucial for clinicians to thoroughly examine the information presented in the dialogue history. However, previous studies often overlook these non-affirmative analyses in their diagnostic processes, which is not conducive to improving diagnostic accuracy.\n\nWe introduce the Deductive Reasoner to evaluate the affirmative and non-affirmative relations between new clinical findings and possible diseases. Given the clinical findings Stsubscript𝑆𝑡S_{t}italic_S start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT and the refined disease list E^t′superscriptsubscript^𝐸𝑡′{\\hat{E}_{t}}^{\\prime}over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT, this reasoner applies a pre-trained LLM with a prompt as “analyze if the new clinical findings support, oppose, or are irrelevant to the possible diseases”. We improve the accuracy of analysis by incorporating additional diagnostic knowledge of each disease. The content of specific tags, i.e., findings, disease, and status, is extracted as diagnosis memory Mtsubscript𝑀𝑡M_{t}italic_M start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT for subsequent response generation.\n\n3.3 Thought Alignment\n\nThe clinician preference in consultation is critical, as it differentiates an experienced clinician from a novice clinical student. Prior research has always concentrated on diagnosing the most likely disease and discussing extra symptoms or treatment based on that diagnosis, which does not accurately reflect the dynamics of an actual healthcare consultation. To address this, we have developed the Thought Alignment module, which is designed to adapt preferences akin to that of an expert clinician. The module first prioritizes diseases to be discussed in the subsequent dialogue. Then, it models the thought process and response of real clinicians to align with clinician preferences.\n\nDisease Priority Alignment\n\nWe implement a disease ranker to establish the priority of each disease within the refined disease list E^t′superscriptsubscript^𝐸𝑡′{\\hat{E}_{t}}^{\\prime}over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT. The backbone of this ranker is the BERT encoder. For the input, we combine the dialogue history with each potential disease, formatting it as follows: “[CLS] {history} the next response will discuss: {disease}”. The relevance score of the dialogue history to the discussed disease is calculated:\n\nr⁢(Ut,ei)=𝙼𝙻𝙿⁢(𝚛𝚎𝚙𝚛⁢(Ut;ei)),ei∈E^t′,formulae-sequence𝑟subscript𝑈𝑡subscript𝑒𝑖𝙼𝙻𝙿𝚛𝚎𝚙𝚛subscript𝑈𝑡subscript𝑒𝑖subscript𝑒𝑖superscriptsubscript^𝐸𝑡′r(U_{t},e_{i})=\\mathtt{MLP}(\\mathtt{repr}(U_{t};e_{i})),e_{i}\\in{\\hat{E}_{t}}^% {\\prime},italic_r ( italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ) = typewriter_MLP ( typewriter_repr ( italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ; italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ) ) , italic_e start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ∈ over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT , (3)\n\nwhere 𝚛𝚎𝚙𝚛⁢(⋅)𝚛𝚎𝚙𝚛⋅\\mathtt{repr}(\\cdot)typewriter_repr ( ⋅ ) extracts the hidden state of the “[CLS]” token as the representation, and 𝙼𝙻𝙿⁢(⋅)𝙼𝙻𝙿⋅\\mathtt{MLP}(\\cdot)typewriter_MLP ( ⋅ ) projects the representation to a scalar. The ranking model is also trained using a contrastive loss function. To better adjust the priority within the refined disease list, the selection of negative samples includes the union of this refined list E^t′superscriptsubscript^𝐸𝑡′{\\hat{E}_{t}}^{\\prime}over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT and the pre-annotated disease list Etp⁢r⁢isuperscriptsubscript𝐸𝑡𝑝𝑟𝑖E_{t}^{pri}italic_E start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_p italic_r italic_i end_POSTSUPERSCRIPT. The positive diseases are from Etp⁢o⁢s⁢tsuperscriptsubscript𝐸𝑡𝑝𝑜𝑠𝑡E_{t}^{post}italic_E start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_p italic_o italic_s italic_t end_POSTSUPERSCRIPT. We compute relevance scores between the dialogue history and all diseases in the refined list and then reorder the list to E^t′′superscriptsubscript^𝐸𝑡′′{\\hat{E}_{t}}^{\\prime\\prime}over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ′ ′ end_POSTSUPERSCRIPT.\n\nThought Process Alignment\n\nThought processes are a reflection of clinician preferences in consultation. Motivated by studies on distilling multi-step reasoning capabilities Fu et al. (2023); Chae et al. (2023), we design a thought distillation method to empower a model that can generate thought processes consistent with clinician preferences. Specifically, we first leverage a pre-trained LLM to deduce a plausible thought process for each doctor’s response. The prompt to the LLM is organized as “complete the thought process based on the dialogue context”. We augment the prompt with 3 human-annotated thought processes in the Chain-of-Thought (CoT) format. The thought extraction can be defined as:\n\nYt∼𝙻𝙻𝙼⁢(Yt|Ut,UtD,prompt).similar-tosubscript𝑌𝑡𝙻𝙻𝙼conditionalsubscript𝑌𝑡subscript𝑈𝑡superscriptsubscript𝑈𝑡𝐷promptY_{t}\\sim\\mathtt{LLM}(Y_{t}|U_{t},U_{t}^{D},\\text{prompt}).italic_Y start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ∼ typewriter_LLM ( italic_Y start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT | italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_D end_POSTSUPERSCRIPT , prompt ) . (4)\n\nThen, we gather the thought process for each dialogue turn and develop a thought process alignment model using the autoregressive language modeling approach as our training objective. The loss function can be defined as:\n\nℒG=−∑jlog⁡p⁢(yj⁢t|Ut,M≤t,Etp⁢o⁢s⁢t,Yt,<j),subscriptℒGsubscript𝑗𝑝conditionalsubscript𝑦𝑗𝑡subscript𝑈𝑡subscript𝑀absent𝑡subscriptsuperscript𝐸𝑝𝑜𝑠𝑡𝑡subscript𝑌𝑡absent𝑗\\mathcal{L}_{\\text{G}}=\\!-\\!\\sum_{j}\\log p(y_{jt}|U_{t},M_{\\leq t},E^{post}_{t% },Y_{t,<j}),caligraphic_L start_POSTSUBSCRIPT G end_POSTSUBSCRIPT = - ∑ start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT roman_log italic_p ( italic_y start_POSTSUBSCRIPT italic_j italic_t end_POSTSUBSCRIPT | italic_U start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_M start_POSTSUBSCRIPT ≤ italic_t end_POSTSUBSCRIPT , italic_E start_POSTSUPERSCRIPT italic_p italic_o italic_s italic_t end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_Y start_POSTSUBSCRIPT italic_t , < italic_j end_POSTSUBSCRIPT ) , (5)\n\nwhere M≤tsubscript𝑀absent𝑡M_{\\leq t}italic_M start_POSTSUBSCRIPT ≤ italic_t end_POSTSUBSCRIPT denotes the diagnosis memory until the t𝑡titalic_t-th turn and Etp⁢o⁢s⁢tsubscriptsuperscript𝐸𝑝𝑜𝑠𝑡𝑡E^{post}_{t}italic_E start_POSTSUPERSCRIPT italic_p italic_o italic_s italic_t end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT denotes the diseases discussed in the next response. During the inference, we utilize the top-K′′superscript𝐾′′K^{\\prime\\prime}italic_K start_POSTSUPERSCRIPT ′ ′ end_POSTSUPERSCRIPT diseases in the list E^t′′superscriptsubscript^𝐸𝑡′′{\\hat{E}_{t}}^{\\prime\\prime}over^ start_ARG italic_E end_ARG start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ′ ′ end_POSTSUPERSCRIPT instead of Etp⁢o⁢s⁢tsubscriptsuperscript𝐸𝑝𝑜𝑠𝑡𝑡E^{post}_{t}italic_E start_POSTSUPERSCRIPT italic_p italic_o italic_s italic_t end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT and their related analyses to generate the thought process. The final response is extracted from “Therefore, the doctor responds {response}”.\n\n4 Thought Process Corpus\n\nIn this section, we present the medical dialogue thought process corpus, MEDIATOR, where each dialogue turn is annotated with a chain-of-thought reasoning path. We utilize the powerful reasoning ability of GPT-4 and its impressive professional skills in the medical domain for automatic annotation. The annotated reasoning path is expected to reflect the thought process of clinicians who analyze the patient’s condition and determine what to discuss. Two datasets, MedDG Liu et al. (2022b) and KaMed Li et al. (2021), are annotated following the few-shot prompt in §3.3. As shown in Table 1, the former is annotated with 122K thought processes and the latter with 285K. Each thought process includes a reasoning path consisting of approximately four steps. An example of the generated thought process is displayed in Table 2. The doctor investigates the new clinical findings (i.e., discomfort under certain conditions) and plans to discuss allergy issues after multi-step reasoning.\n\nHuman assessments are carried out to evaluate the quality of the generated thought processes. We randomly select 100 samples from each dataset and ask three medical students who have undergone clinical internships to assess them. The evaluation employs three metrics: (1) Knowledge: whether the knowledge used in the thought process is accurate; (2) Consistency: whether the thought process is consistent with the dialogue history; (3) Rationality: whether the thought process starts with premises and uses logical progression to derive responses. Table 3 presents the evaluation results, demonstrating that the thought processes in MEDIATOR adequately fulfill the above three criteria.\n\n5 Experiments\n\n5.1 Datasets\n\nOur experiments utilize two medical dialogue datasets, MedDG Liu et al. (2022b) and KaMed Li et al. (2021). Dialogues in these datasets exhibit a clear multi-turn context, with each dialogue averaging about 10 turns. The MedDG dataset comprises 17,860 dialogues, focusing on 12 gastroenterology-related diseases. The dataset is divided into 14,862/1,999/999 for training, validation, and testing. The KaMed dataset includes more than 63,000 dialogues, spanning a wide range of diseases across approximately 100 hospital departments. We clean privacy-sensitive content following DFMed Xu et al. (2023) and divide the dataset into 29,159/1,532/1,539 for training, validation, and testing.\n\n5.2 Baseline methods\n\nWe compare our method with two categories of baselines: LLMs equipped with Chinese medical conversation abilities and language models that are fine-tuned on target datasets.\n\nMedical LLMs.\n\n(1) HuatuoGPT-II Chen et al. (2023) is a medical LLM performing state-of-the-art in several Chinese medical tasks. (2) DISC-MedLLM Bao et al. (2023) is a medical LLM with strong multi-turn consultation capabilities. (3) GPT-4 OpenAI (2023) is one of the most advanced pre-trained LLMs designed by OpenAI.\n\nFine-tuned Models.\n\n(1) VRBot Li et al. (2021) is a medical dialogue generation (MDG) model with entity tracking and predicting. (2) GPT-2 Radford et al. (2019) is a transformer decoder-based language model. (3) BART Lewis et al. (2020) is a transformer-based encoder-decoder model. (4) Qwen-7B Bai et al. (2023) is a strong base language model focusing on Chinese and English. (5) DFMed Xu et al. (2023) enhances MDG with entity and dialogue act flow learning.\n\n5.3 Implementation Details\n\nAll the prompt-based operations in Emulation are implemented with gpt-3.5-turbo, i.e., clinical findings extractions, abductive diagnosis refinement, and deductive diagnosis analysis. We apply the MedBERT pre-trained in the medical domain as the backbone of the disease retriever and the disease alignment model. The corpus of disease documents, utilized for disease retrieval and to enhance both abductive and deductive reasoning, is derived from a specialist-certified online medical knowledge base xiaohe. We retrieve the top 50 (K𝐾Kitalic_K=50) relevant diseases for further refinement. The refined disease list is sent to the disease alignment model to obtain the top 5 (K′′superscript𝐾′′K^{\\prime\\prime}italic_K start_POSTSUPERSCRIPT ′ ′ end_POSTSUPERSCRIPT=5) diseases that may be discussed in subsequent responses. Then, we employ the pre-trained language model Qwen-7B-Chat to train the thought process alignment model, which has seven billion parameters and proficient Chinese understanding and generation ability. We train the model using the LoRA approach with r𝑟ritalic_r=64 and α𝛼\\alphaitalic_α=16. All experiments are carried out on a system equipped with four RTX 3090 GPUs. Other details are presented in the Appendix A.3.\n\n5.4 Automatic Evaluation\n\nWe assess the generated responses using three automated metrics: BLEU-1/2/4 (B-1/4) Papineni et al. (2002), evaluating n𝑛nitalic_n-gram precision; ROUGE-1/2 (R-1/2) Lin (2004), assessing n𝑛nitalic_n-gram recall; and Entity-F1 (E-F) Liu et al. (2022b), which gauges the accuracy of medical entities, such as diseases and medications.\n\nTable 4 displays the response generation results of all baseline methods. Our framework outperforms the baselines in most metrics, especially the medical entity accuracy. It demonstrates the effectiveness of our framework in diagnostic reasoning and response generation. Specifically, Emulation performs better than available medical LLMs trained on large-scale medical dialogues and knowledge bases in R-1/2 and E-F. It demonstrates that modeling the diagnostic reasoning process can help generate more accurate and targeted responses. Besides, our framework achieves better n𝑛nitalic_n-gram recall and entity accuracy than the state-of-the-art model DFMed. The B-1/4 scores are a bit lower, which may be because the fine-tuned parameters are too limited to approach the linguistic pattern of the gold utterances. However, benefiting from the construction of diagnostic reasoning processes, Emulation can generate responses with more consistent content and higher entity accuracy.\n\nWe also adopt another multi-dimensional automatic evaluation using GPT-4, which follows the method in DISC-Med Bao et al. (2023). This evaluation focuses on Proactivity, Accuracy, Helpfulness, and Linguistic Quality (LQ). Our Emulation performs better than other baselines in the above aspects as shown in Table 5.\n\n5.5 Human Evaluation\n\nWe conduct human evaluations on comparison with two baselines: DISC-MedLLM and DFMed. We randomly select 100 samples and ask three medical students to evaluate them according to Knowledge, Consistency, and Specificity. Besides, the overall quality is compared. Emulation outperforms two baselines in all aspects, as shown in Figure 3. Details and case studies are in the Appendix A.5 and A.6. Cross-inference cases are displayed.\n\n5.6 Analysis of Diagnostic Reasoning Process\n\nTo further evaluate the effectiveness of our framework, we analyze several variations of our Emulation as detailed below: (1) w/o Abd. Reasoning, which omits abductive reasoning along with any related deductive reasoning, relying solely on dialogue history to form thought processes. (2) w/o Ded. Reasoning, which eliminates the process of deductively analyzing clinical findings and potential diseases. (3) w/o Dis. Alignment, which forgoes learning the disease priority, opting to select the most relevant diseases identified through abductive reasoning. (4) w/o Thot. Alignment, which directly generates responses based on the results of abductive and deductive reasoning.\n\nTable 6 presents the comprehensive results of our ablation study. There is a noticeable decline in effectiveness across various metrics for the ablation models, underscoring the indispensable contribution of each module within our framework. Particularly, the variant w/o Abd. Reasoning experiences a significant drop in response quality due to the lack of initial diagnosis and subsequent analysis. This decline is attributed to the typical practice of clinicians to center medical conversations around certain diseases; thus, omitting precise abductive and deductive reasoning processes leads to a lack of focus in the dialogue. Besides, the w/o Dis. Alignment variant shows a marked decrease in performance, reinforcing the importance of disease priority alignment with clinician practices for achieving consistent responses. The outcomes from w/o Ded. Reasoning and w/o Thot. Alignment further affirm that detailed analyses and thought generation enhance the quality of response generation.\n\n5.7 Analysis of Disease Alignment\n\nWe evaluate the diagnosis accuracy to determine the impact of aligning disease priorities. The metric Intersection over Union (IoU) between predicted diseases and plausible diseases Etp⁢o⁢s⁢tsuperscriptsubscript𝐸𝑡𝑝𝑜𝑠𝑡E_{t}^{post}italic_E start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_p italic_o italic_s italic_t end_POSTSUPERSCRIPT is employed. As shown in Figure 4, aligned diagnoses substantially outperform unaligned diagnoses that are derived directly from abductive reasoning. Remarkably, aligned diagnoses are marginally more accurate than the diseases diagnosed by GPT-4, i.e., Etp⁢r⁢isuperscriptsubscript𝐸𝑡𝑝𝑟𝑖E_{t}^{pri}italic_E start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_p italic_r italic_i end_POSTSUPERSCRIPT. We also display the diagnosis results in different conversation turns as shown in Figure 5. Overall, the diagnosis accuracy continuously improves as the number of conversation turns increases. The diagnostic accuracy on the MedDG dataset was initially high but decreased in the second turn. It is because the patients in this dataset provide relatively sufficient information in the first turn, allowing Emulation to make a good rough diagnosis. However, with the introduction of additional information, the difficulty of diagnosis increases, and the difference between Emulation’s diagnosis and that of real doctors becomes greater.\n\n6 Related Work\n\nMedical Dialogue Systems\n\nMedical Dialogue Systems (MDS) aim to provide healthcare services to patients. A significant and early area of research focuses on automated diagnosis in the form of task-oriented dialogue systems, which prioritize the quick identification of underlying symptoms and the provision of a final diagnosis and do not offer further consultations Liao et al. (2020); Lin et al. (2019); Chen et al. (2022); Liu et al. (2022a). The study by Wei et al. (2018) presented a dataset with symptom annotations and established an MDS using reinforcement learning. Xu et al. (2019) incorporated a knowledge graph into MDS to control the sequence of symptom inquiries. Tchango et al. (2022) enhanced system dependability by applying an exploration-confirmation approach and giving precedence to severe diseases.\n\nThe emergence of large-scale medical dialogue datasets such as MedDialog Zeng et al. (2020), MedDG Liu et al. (2022b), and KaMed Li et al. (2021), along with pre-trained language models Lewis et al. (2020); Radford et al. (2019), has sparked increased interest in medical dialogue generation Liu et al. (2022b, 2021); Lin et al. (2021); Zhao et al. (2022). The research by Liu et al. (2022b) tackled medical dialogue generation by emphasizing entity prediction and entity-centric response creation. Li et al. (2021) presented a semi-supervised variation reasoning system supplemented by a patient state tracker and a physician action network. Xu et al. (2023) introduced a dual flow (i.e., dialogue act and entity flows) modeling approach to enhance dialogue understanding and guide response generation using acts and entities. Dou et al. (2023) applies LLMs to medical dialogue generation in a plug-and-play way.\n\nMedical Large Language Models\n\nGiven the astonishing performance of GPT-4 in several medical examinations, an increasing number of researchers are directing their attention toward developing medical LLMs. ChatDoctor Li et al. (2023) is equipped with an external Wikipedia knowledge base and trained on real medical conversations. DoctorGLM Xiong et al. (2023) is developed using a medical dialogue and question answering dataset supplemented by ChatGPT-translated documents. HuatuoGPT-2 Chen et al. (2023) and DISC-MedLLM Bao et al. (2023) try to construct a unified domain adaption framework that uses ChatGPT to convert available documents into pre-training and fine-tuning instructions.\n\nAvailable medical dialogue systems and medical LLMs try to learn from the outcome of the diagnostic reasoning (i.e., high-quality medical dialogue datasets) but ignore the internal thought process of real clinicians and alignment with clinician preferences. Our work seeks to construct a medical dialogue system that aligns with the internal diagnostic reasoning process of real clinicians.\n\n7 Conclusion\n\nThis paper proposes a novel medical dialogue system framework, Emulation, that emulates clinicians’ diagnostic reasoning processes to generate appropriate responses grounded in abductive and deductive diagnostic reasoning analysis and alignment with clinician preferences. Besides, a new diagnostic thought process corpus is presented and utilized to model the clinician preference. Experimental results demonstrate the effectiveness of Emulation on two datasets. One promising area for future work is applying the Emulation framework in telemedicine consultations. With the increasing demand for telemedicine, it is essential to explore how this framework can enhance virtual patient-doctor interactions. Future studies could investigate the framework’s effectiveness in improving patient satisfaction and overall consultation quality in remote settings.\n\nLimitations\n\nWhile our framework outperforms various baseline approaches in medical dialogue generation, there is still room for progress. The corpus for the diagnostic thought process is constructed by inferring from doctors’ responses. Although it has been assessed that the thought processes in the corpus demonstrate a logical sequence, individual steps within these processes might not mirror those of a real clinician precisely. To enhance consistency in generated thought processes, additional human-annotated thought processes should be collected to conduct further alignment.\n\nEthics Statement\n\nOur designed system is intended to improve medical consultations for patient care. All datasets were anonymized upon their publication in dataset papers. Nonetheless, due to the training of our model on a limited number of samples for certain conditions, there’s a possibility that the responses might contain inaccurate information regarding diagnosis, treatment, and safety measures. We advise treating our system as a supplementary resource and seeking professional medical advice when necessary. Additionally, user interactions with the system could potentially expose sensitive data (e.g., user-reported gender), and the online LLM API services should be substituted by a local open-source model if our system is deployed. Therefore, we urge users to meticulously assess the ethical considerations of the generated responses. Moreover, the scientific tools utilized in our research, such as NLTK, ROUGE, Transformers, and various GitHub repositories, are openly accessible for academic purposes. The application of these tools in this study adheres to their designated purposes.\n\nAcknowledgment\n\nThis work was supported by the Research Grants Council of Hong Kong (15207920, 15213323) and the National Natural Science Foundation of China (62076212).\n\nReferences\n\nBai et al. (2023) Jinze Bai, Shuai Bai, Yunfei Chu, Zeyu Cui, Kai Dang, Xiaodong Deng, Yang Fan, Wenbin Ge, Yu Han, Fei Huang, Binyuan Hui, Luo Ji, Mei Li, Junyang Lin, Runji Lin, Dayiheng Liu, Gao Liu, Chengqiang Lu, Keming Lu, Jianxin Ma, Rui Men, Xingzhang Ren, Xuancheng Ren, Chuanqi Tan, Sinan Tan, Jianhong Tu, Peng Wang, Shijie Wang, Wei Wang, Shengguang Wu, Benfeng Xu, Jin Xu, An Yang, Hao Yang, Jian Yang, Shusheng Yang, Yang Yao, Bowen Yu, Hongyi Yuan, Zheng Yuan, Jianwei Zhang, Xingxuan Zhang, Yichang Zhang, Zhenru Zhang, Chang Zhou, Jingren Zhou, Xiaohuan Zhou, and Tianhang Zhu. 2023. Qwen technical report. CoRR, abs/2309.16609.\n\nBao et al. (2023) Zhijie Bao, Wei Chen, Shengze Xiao, Kuang Ren, Jiaao Wu, Cheng Zhong, Jiajie Peng, Xuanjing Huang, and Zhongyu Wei. 2023. Disc-medllm: Bridging general large language models and real-world medical consultation. CoRR, abs/2308.14346.\n\nCameron and Turtle-Song (2002) Susan Cameron and Imani Turtle-Song. 2002. Learning to write case notes using the soap format. Journal of Counseling & Development, 80(3):286–292.\n\nChae et al. (2023) Hyungjoo Chae, Yongho Song, Kai Tzu-iunn Ong, Taeyoon Kwon, Minjin Kim, Youngjae Yu, Dongha Lee, Dongyeop Kang, and Jinyoung Yeo. 2023. Dialogue chain-of-thought distillation for commonsense-aware conversational agents. In Proceedings of the 2023 Conference on Empirical Methods in Natural Language Processing, EMNLP 2023, Singapore, December 6-10, 2023, pages 5606–5632. Association for Computational Linguistics.\n\nChen et al. (2022) Junying Chen, Dongfang Li, Qingcai Chen, Wenxiu Zhou, and Xin Liu. 2022. Diaformer: Automatic diagnosis via symptoms sequence generation. In Thirty-Sixth AAAI Conference on Artificial Intelligence, AAAI 2022, Thirty-Fourth Conference on Innovative Applications of Artificial Intelligence, IAAI 2022, The Twelveth Symposium on Educational Advances in Artificial Intelligence, EAAI 2022 Virtual Event, February 22 - March 1, 2022, pages 4432–4440. AAAI Press.\n\nChen et al. (2023) Junying Chen, Xidong Wang, Anningzhe Gao, Feng Jiang, Shunian Chen, Hongbo Zhang, Dingjie Song, Wenya Xie, Chuyi Kong, Jianquan Li, Xiang Wan, Haizhou Li, and Benyou Wang. 2023. Huatuogpt-ii, one-stage training for medical adaption of llms. CoRR, abs/2311.09774.\n\nDou et al. (2023) Chengfeng Dou, Zhi Jin, Wenpin Jiao, Haiyan Zhao, Yongqiang Zhao, and Zhengwei Tao. 2023. PlugMed: Improving specificity in patient-centered medical dialogue generation using in-context learning. In Findings of the Association for Computational Linguistics: EMNLP 2023, pages 5050–5066, Singapore. Association for Computational Linguistics.\n\nElstein et al. (1978) Arthur S Elstein, Lee S Shulman, and Sarah A Sprafka. 1978. Medical problem solving: An analysis of clinical reasoning. Harvard University Press.\n\nFu et al. (2023) Yao Fu, Hao Peng, Litu Ou, Ashish Sabharwal, and Tushar Khot. 2023. Specializing smaller language models towards multi-step reasoning. In International Conference on Machine Learning, ICML 2023, 23-29 July 2023, Honolulu, Hawaii, USA, volume 202 of Proceedings of Machine Learning Research, pages 10421–10430. PMLR.\n\nGao et al. (2021) Tianyu Gao, Xingcheng Yao, and Danqi Chen. 2021. SimCSE: Simple contrastive learning of sentence embeddings. In Proceedings of the 2021 Conference on Empirical Methods in Natural Language Processing, pages 6894–6910, Online and Punta Cana, Dominican Republic. Association for Computational Linguistics.\n\nHolyoak and Morrison (2005) Keith J Holyoak and Robert G Morrison. 2005. The Cambridge handbook of thinking and reasoning. Cambridge University Press.\n\nLewis et al. (2020) Mike Lewis, Yinhan Liu, Naman Goyal, Marjan Ghazvininejad, Abdelrahman Mohamed, Omer Levy, Veselin Stoyanov, and Luke Zettlemoyer. 2020. BART: denoising sequence-to-sequence pre-training for natural language generation, translation, and comprehension. In Proceedings of the 58th Annual Meeting of the Association for Computational Linguistics, ACL 2020, pages 7871–7880. Association for Computational Linguistics.\n\nLi et al. (2021) Dongdong Li, Zhaochun Ren, Pengjie Ren, Zhumin Chen, Miao Fan, Jun Ma, and Maarten de Rijke. 2021. Semi-supervised variational reasoning for medical dialogue generation. In SIGIR ’21: The 44th International ACM SIGIR Conference on Research and Development in Information Retrieval, Virtual Event, Canada, July 11-15, 2021, pages 544–554. ACM.\n\nLi et al. (2023) Yunxiang Li, Zihan Li, Kai Zhang, Ruilong Dan, Steve Jiang, and You Zhang. 2023. Chatdoctor: A medical chat model fine-tuned on a large language model meta-ai (llama) using medical domain knowledge. Cureus, 15(6).\n\nLiao et al. (2020) Kangenbei Liao, Qianlong Liu, Zhongyu Wei, Baolin Peng, Qin Chen, Weijian Sun, and Xuanjing Huang. 2020. Task-oriented dialogue system for automatic disease diagnosis via hierarchical reinforcement learning. ArXiv, abs/2004.14254.\n\nLin (2004) Chin-Yew Lin. 2004. ROUGE: A package for automatic evaluation of summaries. In Text Summarization Branches Out, pages 74–81, Barcelona, Spain. Association for Computational Linguistics.\n\nLin et al. (2021) Shuai Lin, Pan Zhou, Xiaodan Liang, Jianheng Tang, Ruihui Zhao, Ziliang Chen, and Liang Lin. 2021. Graph-evolving meta-learning for low-resource medical dialogue generation. In Thirty-Fifth AAAI Conference on Artificial Intelligence, AAAI 2021, Thirty-Third Conference on Innovative Applications of Artificial Intelligence, IAAI 2021, The Eleventh Symposium on Educational Advances in Artificial Intelligence, EAAI 2021, Virtual Event, February 2-9, 2021, pages 13362–13370. AAAI Press.\n\nLin et al. (2019) Xinzhu Lin, Xiahui He, Qin Chen, Huaixiao Tou, Zhongyu Wei, and Ting Chen. 2019. Enhancing dialogue symptom diagnosis with global attention and symptom graph. In Proceedings of the 2019 Conference on Empirical Methods in Natural Language Processing and the 9th International Joint Conference on Natural Language Processing (EMNLP-IJCNLP), pages 5033–5042, Hong Kong, China. Association for Computational Linguistics.\n\nLiu et al. (2022a) Wenge Liu, Yi Cheng, Hao Wang, Jianheng Tang, Yafei Liu, Ruihui Zhao, Wenjie Li, Yefeng Zheng, and Xiaodan Liang. 2022a. \"my nose is running.\" \"are you also coughing?\": Building A medical diagnosis agent with interpretable inquiry logics. In Proceedings of the Thirty-First International Joint Conference on Artificial Intelligence, IJCAI 2022, Vienna, Austria, 23-29 July 2022, pages 4266–4272. ijcai.org.\n\nLiu et al. (2022b) Wenge Liu, Jianheng Tang, Yi Cheng, Wenjie Li, Yefeng Zheng, and Xiaodan Liang. 2022b. Meddg: An entity-centric medical consultation dataset for entity-aware medical dialogue generation. In Natural Language Processing and Chinese Computing - 11th CCF International Conference, NLPCC 2022, Guilin, China, September 24-25, 2022, Proceedings, Part I, volume 13551 of Lecture Notes in Computer Science, pages 447–459. Springer.\n\nLiu et al. (2021) Wenge Liu, Jianheng Tang, Xiaodan Liang, and Qingling Cai. 2021. Heterogeneous graph reasoning for knowledge-grounded medical dialogue system. Neurocomputing, 442:260–268.\n\nMurray et al. (2007) Elizabeth Murray, Lance Pollack, Martha White, and Bernard Lo. 2007. Clinical decision-making: physicians’ preferences and experiences. BMC Family Practice, 8(1):1–10.\n\nOpenAI (2023) OpenAI. 2023. GPT-4 technical report. CoRR, abs/2303.08774.\n\nPapineni et al. (2002) Kishore Papineni, Salim Roukos, Todd Ward, and Wei-Jing Zhu. 2002. Bleu: a method for automatic evaluation of machine translation. In Proceedings of the 40th Annual Meeting of the Association for Computational Linguistics, pages 311–318, Philadelphia, Pennsylvania, USA. Association for Computational Linguistics.\n\nPatel and Ramoni (1997) Vimla L Patel and Marco F Ramoni. 1997. Cognitive models of directional inference in expert medical reasoning.\n\nRadford et al. (2019) Alec Radford, Jeffrey Wu, Rewon Child, David Luan, Dario Amodei, Ilya Sutskever, et al. 2019. Language models are unsupervised multitask learners. OpenAI blog, 1(8):9.\n\nSilverman et al. (2016) Jonathan Silverman, Suzanne Kurtz, and Juliet Draper. 2016. Skills for communicating with patients. crc press.\n\nTchango et al. (2022) Arsène Fansi Tchango, Rishab Goel, Julien Martel, Zhi Wen, Gaétan Marceau-Caron, and Joumana Ghosn. 2022. Towards trustworthy automatic diagnosis systems by emulating doctors’ reasoning with deep reinforcement learning. In NeurIPS.\n\nWang et al. (2023) Xuezhi Wang, Jason Wei, Dale Schuurmans, Quoc V. Le, Ed H. Chi, Sharan Narang, Aakanksha Chowdhery, and Denny Zhou. 2023. Self-consistency improves chain of thought reasoning in language models. In The Eleventh International Conference on Learning Representations, ICLR 2023, Kigali, Rwanda, May 1-5, 2023. OpenReview.net.\n\nWei et al. (2018) Zhongyu Wei, Qianlong Liu, Baolin Peng, Huaixiao Tou, Ting Chen, Xuanjing Huang, Kam-fai Wong, and Xiangying Dai. 2018. Task-oriented dialogue system for automatic diagnosis. In Proceedings of the 56th Annual Meeting of the Association for Computational Linguistics (Volume 2: Short Papers), pages 201–207, Melbourne, Australia. Association for Computational Linguistics.\n\nXiong et al. (2023) Honglin Xiong, Sheng Wang, Yitao Zhu, Zihao Zhao, Yuxiao Liu, Linlin Huang, Qian Wang, and Dinggang Shen. 2023. Doctorglm: Fine-tuning your chinese doctor is not a herculean task. CoRR, abs/2304.01097.\n\nXu et al. (2023) Kaishuai Xu, Wenjun Hou, Yi Cheng, Jian Wang, and Wenjie Li. 2023. Medical dialogue generation via dual flow modeling. In Findings of the Association for Computational Linguistics: ACL 2023, pages 6771–6784, Toronto, Canada. Association for Computational Linguistics.\n\nXu et al. (2019) Lin Xu, Qixian Zhou, Ke Gong, Xiaodan Liang, Jianheng Tang, and Liang Lin. 2019. End-to-end knowledge-routed relational dialogue system for automatic diagnosis. In The Thirty-Third AAAI Conference on Artificial Intelligence, AAAI 2019, The Thirty-First Innovative Applications of Artificial Intelligence Conference, IAAI 2019, The Ninth AAAI Symposium on Educational Advances in Artificial Intelligence, EAAI 2019, Honolulu, Hawaii, USA, January 27 - February 1, 2019, pages 7346–7353. AAAI Press.\n\nYu et al. (2024) Kun-Hsing Yu, Elizabeth Healey, Tze-Yun Leong, Isaac S Kohane, and Arjun K Manrai. 2024. Medical artificial intelligence and human values. New England Journal of Medicine, 390(20):1895–1904.\n\nZeng et al. (2020) Guangtao Zeng, Wenmian Yang, Zeqian Ju, Yue Yang, Sicheng Wang, Ruisi Zhang, Meng Zhou, Jiaqi Zeng, Xiangyu Dong, Ruoyu Zhang, Hongchao Fang, Penghui Zhu, Shu Chen, and Pengtao Xie. 2020. MedDialog: Large-scale medical dialogue datasets. In Proceedings of the 2020 Conference on Empirical Methods in Natural Language Processing (EMNLP), pages 9241–9250, Online. Association for Computational Linguistics.\n\nZhao et al. (2022) Yu Zhao, Yunxin Li, Yuxiang Wu, Baotian Hu, Qingcai Chen, Xiaolong Wang, Yuxin Ding, and Min Zhang. 2022. Medical dialogue response generation with pivotal information recalling. In KDD ’22: The 28th ACM SIGKDD Conference on Knowledge Discovery and Data Mining, Washington, DC, USA, August 14 - 18, 2022, pages 4763–4771. ACM.\n\nAppendix A Appendix\n\nA.1 Automatic Evaluation Details\n\nWe adopt the calculation approach used in the original dataset paper MedDG Liu et al. (2022b) and in the most recent paper DFMed Xu et al. (2023). The “nltk” package with version 4.5.1 is used to calculate BLEU scores. The “rouge” version is 1.0.1. There is a score gap between our study and some baseline studies since the metric package used for calculating BLEU is different. For example, the officially released code for VRBot doesn’t specify the metric package version such as “nlgeval” and “rouge”, while the results will be affected by the package version.\n\nA.2 Disease Annotation\n\nWe annotate the potential diseases for each dialogue turn with the help of GPT-4 using two different prompts. One is “Generate which disease the patient may suffer from based on the medical conversation and explain why. The diseases should be ranked by their possibility according to the conversation.” This prompt aims to leverage the diagnostic capability of GPT-4 to infer potential diseases. The other is “Generate which disease the doctor is considering or intending to rule out based on the doctor’s response and explain why. The diseases should be mainly ranked by their relationship to the response.” This prompt aims to deduce diseases from the doctor’s response. The difference between these two prompts is whether the current doctor’s response is given. Examples of two disease annotation prompts are shown in Figure 6 and Figure 7.\n\nAfter inferring diseases using two prompts respectively, we need to link each inferred disease to the disease in an external knowledge base. We divide this linking into two steps: (1) Coarse matching and (2) GPT-4 assisted matching. For the coarse matching, we first build a dense retriever to calculate the relevance score between disease name and disease documents. The disease documents are from the knowledge base. This retriever can bridge the gap between different aliases of one disease. Then, we retrieve the top 10 relevant diseases as a preliminary list. For the GPT-4 assisted matching, we organize a prompt that requires GPT-4 to select from the preliminary disease list. The prompt is “Select diseases from the candidate disease list that describe the same one as our target.” An example of a disease match prompt is shown in Figure 8.\n\nA.3 Implementation Details\n\nBaseline Methods.\n\nFor the medical LLMs, we use the HuatuoGPT2-13B and DISC-MedLLM to generate responses in zero-shot way as they have already been fine-tuned on medical dialogue datasets and other large-scale medical knowledge datasets. These two models are all based on language models with 13B parameters. We utilize the default decoding parameters to generate responses.\n\nFor fine-tuned baseline methods, we employ generation results from the original papers.\n\nFine-tuned modules in our framework.\n\nFor training disease retriever in §3.1, we use the MedBERT as the encoder and employ contrastive learning. The batch size is 8 with 6 gradient accumulation steps. The learning rate is set at 3e-5. We train 6 epochs for the MedDG dataset and 10 epochs for the KaMed dataset. We select the checkpoint with the highest disease recall rate in validation datasets.\n\nFor training the disease priority alignment model, we also use the MedBERT as the encoder and employ contrastive learning. The batch size is 2 with 8 gradient accumulation steps. The learning rate is set at 1e-5. We train 3 epochs for two datasets and select the checkpoint with the highest IoU in validation datasets.\n\nFor training the thought process generation model, we use the Qwen-7B-Chat model and adopt LoRa fine-tuning. The LoRa settings are: r𝑟ritalic_r equals 64, α𝛼\\alphaitalic_α equals 16, dropout rate equals 0.05. The learning rate is set at 3e-4, the batch size for each GPU is 2 with 8 gradient accumulation steps. We train the LoRa parameters for 3 epochs and select the last checkpoint to generate responses.\n\nPrompt modules in our framework.\n\nFor the abductive reasoner, the prompt is shown in Figure 9. For the deductive reasoner, the prompt is shown in Figure 10.\n\nA.4 Disease Retrieval Results\n\nTable 7 displays the recall rate of different top-K𝐾Kitalic_K diseases (i.e., K𝐾Kitalic_K=10, 25, 50, 100).\n\nA.5 Human Evaluations on Comparison with Baseline Methods\n\nWe compare our framework Emulation with baseline methods from three aspects. (1) Knowledge Accuracy (Knowledge), which assesses whether the response correctly applies the disease knowledge. (2) Consistency, which assesses whether the response is consistent with the dialogue context and doctor’s ground truth response. (3) Specificity, which assesses whether the response provides specific diagnoses, prescriptions, treatment plans, or examination requirements rather than general suggestions. We ask our annotators to compare the responses generated by our method with the responses generated by baseline methods.\n\nA.6 Case Studies\n\nFigure 11 and Figure 12 display cases on the MedDG and KaMed datasets, respectively. Besides, we also infer samples in MedDG with the model trained on KaMed and infer samples in KaMed with the model trained on MedDG in Figure 13 and Figure 14."
    }
}