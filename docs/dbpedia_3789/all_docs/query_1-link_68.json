{
    "id": "dbpedia_3789_1",
    "rank": 68,
    "data": {
        "url": "https://community.cisco.com/t5/service-providers-knowledge-base/understanding-mpls-traffic-engineering-te-label-operations/ta-p/3127625",
        "read_more_link": "",
        "language": "en",
        "title": "Understanding MPLS Traffic Engineering (TE) Label Operations",
        "top_image": "https://community.cisco.com/html/assets/ciscooglogo.png",
        "meta_img": "https://community.cisco.com/html/assets/ciscooglogo.png",
        "images": [
            "https://community.cisco.com/legacyfs/online/legacy/2/2/0/143022-profile_image_500",
            "https://community.cisco.com/html/@B2A4946D498FC535C084904363ACA0EE/rank_icons/rank-7.png",
            "https://community.cisco.com/legacyfs/online/legacy/6/0/7/92706-End%20to%20End%20Tunnel.png",
            "https://community.cisco.com/legacyfs/online/legacy/1/1/7/92711-PE%20to%20P%20Tunnel.png",
            "https://community.cisco.com/legacyfs/online/legacy/2/7/7/92772-Tunnel%20to%20Tunnel.png",
            "https://community.cisco.com/t5/image/serverpage/avatar-name/default_icon/avatar-theme/candy/avatar-collection/Cisco_Default/avatar-display-size/profile/version/2?xdesc=1.0",
            "https://community.cisco.com/html/@E1D9E5099E7D8FD73DECA4D3FF50F455/rank_icons/rank-1.png",
            "https://community.cisco.com/t5/image/serverpage/avatar-name/default_icon/avatar-theme/candy/avatar-collection/Cisco_Default/avatar-display-size/profile/version/2?xdesc=1.0",
            "https://community.cisco.com/html/@D17C385B8A505F8125C5E271F02ACC75/rank_icons/ciscologo-square_16x16.png",
            "https://community.cisco.com/legacyfs/online/avatars/a16274_30.png",
            "https://community.cisco.com/html/@E1D9E5099E7D8FD73DECA4D3FF50F455/rank_icons/rank-1.png"
        ],
        "movies": [],
        "keywords": [],
        "meta_keywords": [
            ""
        ],
        "tags": null,
        "authors": [
            "community.cisco.com",
            "user-id"
        ],
        "publish_date": "2012-06-21T16:41:56+00:00",
        "summary": "",
        "meta_description": "One of the biggest challenges in troubleshooting is understanding expected behavior. If we don't know what it is supposed to look like in the working state, how can we tell if we are in a broken state? In this document we will explore label",
        "meta_lang": "en",
        "meta_favicon": "https://community.cisco.com/html/@D17C385B8A505F8125C5E271F02ACC75/rank_icons/ciscologo-square_16x16.png",
        "meta_site_name": "",
        "canonical_link": "https://community.cisco.com/t5/service-providers-knowledge-base/understanding-mpls-traffic-engineering-te-label-operations/ta-p/3127625",
        "text": "One of the biggest challenges in troubleshooting is understanding expected behavior. If we don't know what it is supposed to look like in the working state, how can we tell if we are in a broken state?\n\nIn this document we will explore label operations hop-by-hop through three common topologies for Traffic Engineering tunnels. These examples carry customer pseudowires (l2vpn) but the same concepts would apply for L3VPN as well.\n\nPE to PE Tunnel\n\nFor our first example we have a pseudowire between PE2 and PE4. There is also a pair of TE tunnels that run end-to-end between PE2 and PE4.\n\nLet's look at the label operations from PE2 to PE4\n\nFirst, we verify the labels on the pseudowire\n\nPE2#show mpls l2 vc detail\n\nLocal interface: Et0/1 up, line protocol up, Ethernet up\n\nDestination address: 14.14.14.14, VC ID: 24, VC status: up\n\nOutput interface: Tu0, imposed label stack {41 31}\n\nPreferred path: Tunnel0, active\n\nDefault path: ready\n\nNext hop: point2point\n\nWe can see that two labels get imposed: The LDP label, 41 and the Pseudowire Label, 31\n\nSince we are using a TE Tunnel (as you can see above, \"Output interface: Tu0\") the LDP label will be called the \"TE Label\" or \"Tunnel Label\".\n\nWe can dive a little deeper into the tunnel and see the Tunnel Instance, Outgoing Tunnel Label and exact path\n\nPE2#show mpls traffic-eng tunnels tunnel 0\n\nName: PE2_t0 (Tunnel0) Destination: 14.14.14.14\n\nStatus:\n\nAdmin: up Oper: up Path: valid Signalling: connected\n\npath option 1, type dynamic (Basis for Setup, path weight 50)\n\nInLabel : -\n\nOutLabel : Ethernet0/0, 41\n\nNext Hop : 2.0.0.2\n\nRSVP Signalling Info:\n\nSrc 22.22.22.22, Dst 14.14.14.14, Tun_Id 0, Tun_Instance 203\n\nRSVP Path Info:\n\nMy Address: 2.0.0.12\n\nExplicit Route: 2.0.0.2 4.0.0.2 4.0.0.4 6.0.0.4\n\n6.0.0.6 8.0.0.6 8.0.0.8 84.0.0.8\n\n84.0.0.4 14.14.14.14\n\nKnowing that label 41 will be on the top of the label stack (remember the label output is read {top->bottom}) we can look for this label on P2 (the next hop according to the Explicit Route).\n\nP2#show mpls forwarding label 41\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n41 28 22.22.22.22 0 [203] \\\n\n5610 Et0/0 4.0.0.4\n\nIn this output we can see the local label (the label we assigned and sent upstream to the PE), the outgoing label (the label we need to use to go downstream to the next hop) and the Tunnel ID, which matches the Tunnel Instance we saw on the head-end.\n\nIf we needed to find out more information about this specific tunnel from the P2 router, we can do that too. By asking P2 about the tunnel sourced from PE2 (22.22.22.22) and destined for PE4 (14.14.14.14)\n\nP2#show mpls traffic-eng tunnel source-id 22.22.22.22 destination 14.14.14.14\n\nP2P TUNNELS/LSPs:\n\nLSP Tunnel PE2_t0 is signalled, connection is up\n\nInLabel : Ethernet0/1, 41\n\nPrev Hop : 2.0.0.12\n\nOutLabel : Ethernet0/0, 28\n\nNext Hop : 4.0.0.4\n\nRSVP Signalling Info:\n\nSrc 22.22.22.22, Dst 14.14.14.14, Tun_Id 0, Tun_Instance 203\n\nRSVP Path Info:\n\nMy Address: 4.0.0.2\n\nExplicit Route: 4.0.0.4 6.0.0.4 6.0.0.6 8.0.0.6\n\n8.0.0.8 84.0.0.8 84.0.0.4 14.14.14.14\n\nNow we continue down the path and look at the next P routers and verify label information\n\nP4#show mpls forwarding label 28\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n28 40 22.22.22.22 0 [203] \\\n\n46841 Et0/0 6.0.0.6\n\nP6#show mpls forwarding label 41\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n40 144 22.22.22.22 0 [203] \\\n\n83918 Et0/1 6.0.0.4\n\nP8#show mpls forwarding label 40\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n144 Pop Label 22.22.22.22 0 [203] \\\n\n47095 Et0/0 84.0.0.4\n\nNow on P8, the Penultimate hop, we see that our outgoing label is pop. With Traffic Engineering, just like L2 or L3VPN, we perform PHP and will pop the top label on the second to last (Penultimate) router. Now, to know what label we expect to see on PE4, we have to think about the label stack. We started with two labels (TE and Pseudowire labels). As we moved through the core we never added any additional labels. This means that the label P8 is removing is only the TE label, leaving the original Pseudowire label. So let's look on PE4 for the Pseudowire label\n\nPE4#show mpls forwarding label 31\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n31 No Label l2ckt(4096) 40483 Et0/0 point2point\n\nHere we see label 31 points to our l2ckt (pseudowire) out Ethernet 0/0.\n\nPE to P Tunnel\n\nNow let's look a scenario where the tunnel terminates on a P router. Again, we'll use a Pseudowire between the CE devices.\n\nWhen we have a TE tunnel that is not end to end and can't forward unlabeled traffic (BGP Free Core, L2/L3VPN) we must run LDP over the TE tunnel. We'll go into the \"why\" as soon as we start looking at the label forwarding.\n\nFirst, on PE1, let's look at the Pseudowire information\n\nPE1#show mpls l2 vc 13 detail\n\nOutput interface: Tu0, imposed label stack {23 19 17}\n\nUnlike the previous example, we see three labels being placed on the frame. These labels (again, {Top->Bottom}) are the TE Label (Between PE1 and P1), LDP Label (between PE1 and P7), and Pseudowire Label (between PE1 and PE3).\n\nAs the labeled packet arrives on P1, it looks as the top (TE) label and swaps.\n\nP1#show mpls forwarding label 23\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n23 20 11.11.11.11 0 [10] \\\n\n549604 Et0/0 3.0.0.3\n\nP3#show mpls forwarding label 20\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n20 22 11.11.11.11 0 [10] \\\n\n727533 Et0/0 5.0.0.5\n\nNow on P5, things get interesting. P5 is the penultimate router, so just like in our previous example P5 needs to pop the label.\n\nP5#show mpls forwarding label 22\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n22 Pop Label 11.11.11.11 0 [10] \\\n\n755760 Et0/0 7.0.0.7\n\nAgain, we think about what our label stack looked like entering P5: {TE Label, LDP Label, Pseudowire Label}. When we pop a single label P5 we expose the LDP Label for P7 to process. Remember, since we turned LDP (mpls ip command) on the Tunnel interface we exchange an LDP label with P7.\n\nP7#show mpls forwarding label 19\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n19 Pop Label 13.13.13.13/32 686357 Et0/0 73.0.0.3\n\nWhat would happen without this? P5 would still be the Penultimate router and would still pop the top (TE) Label. This would expose the Pseudowire and P7 wouldn't know what to do with the packet. Anytime a TE tunnel terminates on a P router you need to enable \"mpls ip\" on that Tunnel interface.\n\nWe should also note that just like P5, P7 is also a Penultimate router, but for a different LSP. Whereas P5 was the Penultimate router for the TE Tunnel, P7 is the Penultimate router for the Pseudowire. So, like any good Penultimate router does, P7 pops the top (LDP) Label.\n\nFinally, what arrives on PE3 is a single label representing the Pseudowire.\n\nPE3#show mpls forwarding label 17\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n17 No Label l2ckt(4096) 530983 Et0/0 point2point\n\nSo the only twist in this scenario is that the TE tunnel ends on a P router, which requires us to add an additional label by enabling \"mpls ip\" on that tunnel interface.\n\nOut of a Tunnel and Back Into a Tunnel\n\nNow let's take a slightly different approach to the previous scenairo. Now we have the first tunnel from PE1 to P3 and a second tunnel from P3 to P7. So our packet will leave the first TE tunnel and enter the second tunnel on the same router.\n\nLast the last two times, we look at the L2VPN information on PE1 to see our starting label stack\n\nPE1#show mpls l2 vc det\n\nLocal interface: Et0/1 up, line protocol up, Ethernet up\n\nDestination address: 13.13.13.13, VC ID: 13, VC status: up\n\nOutput interface: Tu3, imposed label stack {42 22 17}\n\nSince this tunnel ends on a P router we are running LDP over it and see three labels {Tunnel LDP Pseudowire}. Since there are only three routers in the tunnel, the next hop is the Penultimate router.\n\nP1#show mpls forwarding label 42\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n42 Pop Label 11.11.11.11 3 [1] \\\n\n10209 Et0/0 3.0.0.3\n\nP1 will pop the top (Tunnel) label and send the exposed LDP label (22) to P3. When we look at this label on P3 we now see the [T] flag set\n\nP3#show mpls forwarding label 22\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n22 [T] 19 13.13.13.13/32 1587549 Tu7 point2point\n\n[T] Forwarding through a LSP tunnel.\n\nView additional labelling info with the 'detail' option\n\nThis [T] flag is set because we are entering another TE Tunnel. More importantly this LSP is inside the tunnel. This means the outgoing label we see here is not at the top of the stack. Our TE label will be added to the stack after this. We can use the detail option to see both the TE label and LDP label.\n\nP3#show mpls forwarding label 22 detail\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n22 19 13.13.13.13/32 1597350 Tu7 point2point\n\nMAC/Encaps=14/22, MRU=1496, Label Stack{22 19}, via Et0/0\n\nAABBCC025C10AABBCC025B008847 0001600000013000\n\nNo output feature configured\n\nP3#show mpls traffic-eng tunnels tunnel 7\n\nName: P3_t7 (Tunnel7) Destination: 7.7.7.7\n\nStatus:\n\nAdmin: up Oper: up Path: valid Signalling: connected\n\npath option 1, type dynamic (Basis for Setup, path weight 20)\n\nInLabel : -\n\nOutLabel : Ethernet0/0, 22\n\nNext Hop : 5.0.0.5\n\nAgain, the label seen in the \"show mpls forwarding\" output is for the end to end LSP. This LSP gets carried inside a Traffic Engineering tunnel, so we can see this TE label with the detail option or by looking for the TE label the old-fashioned way with \"show mpls traffic-eng tunnels tunnel 7\"\n\nNow P5 only looks at the top (TE) label and acts.\n\nP5#show mpls forwarding label 22\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n22 Pop Label 3.3.3.3 7 [2] 2242162 Et0/0 7.0.0.7\n\nJust as we'd expect the Penultimate router to do, P5 pops the TE label sending on the original LDP label on top to P7. Before we look at P7, let's think about the label stack on the packet leaving P5.\n\nP5 just removed the TE label leaving the P3 <---> P7 LDP label. Under this we should still have the PE1 <---> PE3 Pseudowire label.\n\nP7 sees the P3 LDP label (the one with the [T] flag earlier)\n\nP7#show mpls forwarding label 19\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n19 Pop Label 13.13.13.13/32 29952955 Et0/0 73.0.0.3\n\nThis exposes the Pseudowire label to be processed by PE3\n\nPE3#show mpls forwarding label 17\n\nLocal Outgoing Prefix Bytes Label Outgoing Next Hop\n\nLabel Label or Tunnel Id Switched interface\n\n17 No Label l2ckt(4096) 22508357 Et0/0 point2point\n\nHopefully this paints a picture of how label operations work in various TE tunnel topologies. Fast Reroute scenarios will be covered in the next chapter, coming soon!"
    }
}