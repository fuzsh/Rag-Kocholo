{
    "id": "dbpedia_8742_1",
    "rank": 42,
    "data": {
        "url": "https://raphaelstaebler.info/en/blog/run-contao-4-inside-a-docker-container/",
        "read_more_link": "",
        "language": "en",
        "title": "Run Contao 4 Inside a Docker Container",
        "top_image": "https://raphaelstaebler.info/en/blog/run-contao-4-inside-a-docker-container/title/title.jpg",
        "meta_img": "https://raphaelstaebler.info/en/blog/run-contao-4-inside-a-docker-container/title/title.jpg",
        "images": [
            "https://raphaelstaebler.info/images/profile-img.jpg",
            "https://raphaelstaebler.info/en/blog/run-contao-4-inside-a-docker-container/title/title.jpg"
        ],
        "movies": [],
        "keywords": [],
        "meta_keywords": [
            ""
        ],
        "tags": null,
        "authors": [
            "Raphael StÃ¤bler"
        ],
        "publish_date": null,
        "summary": "",
        "meta_description": "There are many reasons for running applications inside Docker containers. If youâre a developer dealing with lots of different technologies you may know the hassle of providing different runtimeâ¦",
        "meta_lang": "en",
        "meta_favicon": "",
        "meta_site_name": "Raphael StÃ¤bler - Blog",
        "canonical_link": "https://raphaelstaebler.info/en/blog/run-contao-4-inside-a-docker-container/",
        "text": "What is Contao?\n\nContao is an open source content management system based on PHPâs popular Symfony framework.\n\nWhy Docker?\n\nThere are many reasons for running applications inside Docker containers. If youâre a developer dealing with lots of different technologies you may know the hassle of providing different runtime environments to different projects on your local machine. Docker gives you the ability to contain all of these inside of separate containers and keep your machine clean.\n\nThatâs just one reason for Docker. Aside from that, docker makes deployment processes much more predictable while also providing an easy tool for the scalability of your applications.\n\nThe Base Image\n\nDocker images are managed by Dockerfiles. I created a base image for Contao ready to use. It currently only supports Contaoâs 4.4 LTS version.\n\nLetâs break down the Dockerfile â if you just want to use the image and have no interest in its creation you can safely skip this part!\n\nThe image is based on the official PHP 7 image:\n\nFROM php:7-apache\n\nWe then prepare the environment:\n\nENV COMPOSER_MEMORY_LIMIT -1 ENV APACHE_DOCUMENT_ROOT /var/www/html/contao/web WORKDIR /var/www/html\n\nWe install all the necessary dependencies:\n\nRUN apt-get update RUN apt-get install -y \\ libfreetype6-dev \\ libjpeg62-turbo-dev \\ libpng-dev \\ libicu-dev \\ && docker-php-ext-install -j$(nproc) iconv \\ && docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \\ && docker-php-ext-install -j$(nproc) gd \\ && docker-php-ext-install -j$(nproc) intl \\ && docker-php-ext-install -j$(nproc) pdo_mysql RUN apt-get install -y git zip\n\nInstall Contao itself:\n\nRUN curl -sS https://getcomposer.org/installer | php \\ && mv composer.phar /usr/local/bin/composer \\ && composer create-project --no-dev contao/managed-edition /var/www/html/contao '4.4.*'\n\nMake the Contao directory writable for the web server:\n\nRUN chown -R www-data:www-data /var/www/html/contao\n\nEnable apacheâs mod_rewrite:\n\nRUN a2enmod rewrite\n\nChange the web root:\n\nRUN sed -ri -e âs!/var/www/html!${APACHE_DOCUMENT_ROOT}!gâ /etc/apache2/sites-available/*.conf RUN sed -ri -e âs!/var/www/!${APACHE_DOCUMENT_ROOT}!gâ /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf\n\nInitialize php.ini â this is currently set to use in development mode:\n\nRUN mv â$PHP_INI_DIR/php.ini-developmentâ â$PHP_INI_DIR/php.iniâ\n\nDelete Contaoâs cache:\n\nRUN rm -rf /var/www/html/contao/var/cache/*\n\nAnd finally, expose port 80:\n\nEXPOSE 80\n\nThe Docker Environment\n\nIn order to run, Contao also needs a MySQL database. It would be bad practice running the database inside the same container as the web application. Therefore we need another container. Luckily for us, we can just go ahead and use the official MariaDB image. In order to orchestrate several images together I like to use Docker Compose. It allows us to easily combine multiple containers using a YAML file.\n\nAs basic configuration for Contao may look like this:\n\nversion: '3.1' services: database: image: mariadb ports: - 3306:3306 environment: MYSQL_ROOT_PASSWORD: root networks: - default contao: image: productionbuild/contao ports: - networks: - default networks: default:\n\nHere we have two services: a database service based on the official MariaDB image and a Contao service based on my Contao image. The database service exposes port 3306 for MySQL connections and the Contao service exposes port 80 for HTTP connections. They both share an internal network in order to allow for communication between the two.\n\nYou can run this stack by executing:\n\ndocker stack deploy -c docker-compose.yml contao\n\nYou should now be able to connect the MySQL database on localhost:3306. Make sure thereâs no other MySQL instance running on that port or map this one to another port by modifying the file docker-compose.yml.\n\nNow, if you were to connect to the database and make some changes like, say, creating a new database those changes would be saved inside the running docker container. That would be bad because once you terminate the container the database would be lost.\n\nPersistence\n\nDocker containers are meant to be disposable. You should be able to create them and throw them away as you wish without any significant loss of data.\n\nThatâs why we need to store the database files outside the container, so they can persist. You do this by using volumes:\n\nservices: database: image: mariadb ports: - 3306:3306 environment: MYSQL_ROOT_PASSWORD: root volumes: - ./db:/var/lib/mysql networks: - default\n\nAdding these two lines allows us to map the directory /var/lib/mysql inside the container to a directory outside of it â in this case ./db. Make sure that directory actually exists.\n\nMake those changes, terminate the stack und re-deploy it:\n\ndocker stack rm contao docker stack deploy -c docker-compose.yml contao\n\nNow you can connect to the database and safely create a new database for Contao. If you wish you can create a user for Contao, too.\n\nBefore we now go ahead and complete Contaoâs installation, we need to be aware of a few things. Of course, Contao also needs to persist some data otherwise youâd have to set it up every time you start a container.\n\nI propose to map the following volumes to Contaoâs container:\n\ncontao: image: productionbuild/contao ports: - volumes: - ./contao/composer.json:/var/www/html/contao/composer.json - ./contao/app/config:/var/www/html/contao/app/config - ./contao/system/config:/var/www/html/contao/system/config - ./contao/app/Resources:/var/www/html/contao/app/Resources - ./contao/templates:/var/www/html/contao/templates - ./contao/files:/var/www/html/contao/files - ./contao/src:/var/www/html/contao/src networks: - default\n\nWhat are these?\n\ncomposer.json is the core of Contaoâs (and Symfonyâs for that matter) dependency management. You need to get the one for your Contao version before you can map it to the container. An easy way may be to get the one thatâs currently inside your running container:\n\ndocker exec [container id] cat contao/composer.json\n\napp/config will hold configuration files after the installation and will allow you to add additional files.\n\napp/Resources can include subdirectories like contao/config, contao/dca, contao/languages, contao/tempaltes as well as ContaoCoreBundle/views. How to use those directories is outside the scope of this post and may be covered at another time.\n\nsystem/config also holds configuration files after the installation.\n\ntemplates is where youâll put your custom templates.\n\nfiles will contain images, CSS, JS and other files.\n\nsrc is where Contao and Symfony recommend you to put your custom code.\n\nYou may need to map other files and directories, too. For example, you may require a file contao/app/ContaoManagerPlugin.php. Depending on what you do you may also require less volumes. If you donât plan on creating custom code you can safely ignore contao/src for example.\n\nYour own Dockerfile\n\nWhatever your exact requirements are, try to separate between Contao core files and files that need customization. As an example, try to avoid putting the directory contao/vendor outside the container. Instead create a new image based on the Contao base image that respects your composer.json and installs its dependencies on creation, not on startup. You then use your new image in your Docker Compose configuration. Now, every time a dependency changes you need to update your image but thatâs okay as images are easily updated.\n\nYour own Dockerfile may look something like this:\n\nFROM productionbuild/contao:lts COPY ./contao/composer.json /var/www/html/contao/composer.json RUN composer update -d contao && \\ composer install -d contao && \\ composer dump-autoload -d contao RUN chown -R www-data:www-data /var/www/html/contao RUN rm -rf /var/www/html/contao/var/cache/* EXPOSE 80\n\nNow create your image:\n\ndocker build -t my-own-contao-image .\n\nAnd update your docker-compose.yml:\n\ncontao: image: my-own-contao-image ports: - â¦\n\nVersion Control\n\nMake sure to put your Dockerfile and your docker-compose.yml in your Git repository alongside your code and youâve got yourself a complete setup to run your Contao application on any machine supporting Docker.\n\nInstall and Configure Contao\n\nWe still havenât actually configured Contao, have we?\n\nAs you run your Docker stack, you can navigate to http://localhost/contao/install which will guide you through a short setup process.\n\nYouâll need to enter your database credentials. Note that the databaseâs host will be named after the corresponding service in your docker-compose.yml. In this case the hostâs name is database.\n\nAfter setting up Contao, all the database tables and configuration files will persist outside the containers. So, itâs safe to shut down the whole stack and run it again whenever you need it. Your Contao setup will be preserved.\n\nConclusion\n\nUsing this setup will allow you to easily create development environments for your different Contao projects and will enable you to share them with other developers.\n\nWith some modification this setup may even be used to deploy Contao projects to production environments."
    }
}