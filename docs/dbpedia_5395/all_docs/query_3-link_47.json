{
    "id": "dbpedia_5395_3",
    "rank": 47,
    "data": {
        "url": "https://www.dsmtuners.com/threads/e931-eprom-deadtime-address-off-by-2-bytes.541572/",
        "read_more_link": "",
        "language": "en",
        "title": "General - E931 Eprom Deadtime Address off by 2 bytes?",
        "top_image": "https://www.dsmtuners.com/data/assets/logo/dsmtuners-icon-512.png",
        "meta_img": "https://www.dsmtuners.com/data/assets/logo/dsmtuners-icon-512.png",
        "images": [
            "https://www.dsmtuners.com/images/logo-dsmtuners-300.png",
            "https://www.dsmtuners.com/images/logo-dsmtuners-300.png",
            "https://www.dsmtuners.com/data/assets/mobile-logo/logo-dsmtuners-mobile.png",
            "https://www.dsmtuners.com/images/supporters/supporter-morrison-fab.jpg",
            "https://www.dsmtuners.com/images/supporters/supporter-stm-750x66.jpg",
            "https://www.dsmtuners.com/images/supporters/supporter-epsi-750x66.jpg",
            "https://www.dsmtuners.com/data/attachments/139/139746-62bcc2847d7ab45291fd9384cfb1d3c5.jpg",
            "https://www.dsmtuners.com/data/avatars/m/170/170598.jpg?1622731132",
            "https://www.dsmtuners.com/data/attachments/650/650556-774de26f045dfd579c206d0cc5db2011.jpg",
            "https://www.dsmtuners.com/styles/default/xenforo/smilies/laugh.gif",
            "https://www.dsmtuners.com/data/attachments/139/139746-62bcc2847d7ab45291fd9384cfb1d3c5.jpg",
            "https://www.dsmtuners.com/data/avatars/m/20/20915.jpg?1573712424",
            "https://www.dsmtuners.com/data/attachments/245/245681-1381a093b21be374b434022755cc3ff8.jpg",
            "https://www.dsmtuners.com/data/attachments/689/689597-5567c9b39acb9812a0c3fbe0849b0e3f.jpg",
            "https://www.dsmtuners.com/data/avatars/m/170/170598.jpg?1622731132",
            "https://www.dsmtuners.com/data/attachments/650/650556-774de26f045dfd579c206d0cc5db2011.jpg",
            "https://www.dsmtuners.com/data/avatars/m/170/170598.jpg?1622731132",
            "https://www.dsmtuners.com/data/attachments/650/650556-774de26f045dfd579c206d0cc5db2011.jpg",
            "https://www.dsmtuners.com/data/attachments/139/139746-62bcc2847d7ab45291fd9384cfb1d3c5.jpg",
            "https://www.dsmtuners.com/data/avatars/m/170/170598.jpg?1622731132",
            "https://www.dsmtuners.com/data/attachments/650/650556-774de26f045dfd579c206d0cc5db2011.jpg",
            "https://www.dsmtuners.com/data/avatars/m/163/163807.jpg?1572776122",
            "https://www.dsmtuners.com/data/attachments/493/493212-2c7d06d418a0f7f427ae16d08be816e4.jpg",
            "https://www.dsmtuners.com/data/attachments/682/682348-1aaba3e03c5df451c567087f109dc14f.jpg",
            "https://www.dsmtuners.com/data/avatars/m/0/164.jpg?1333338170",
            "https://www.dsmtuners.com/data/attachments/588/588290-06fba777cbd46cb75b2e6a352c8d58f4.jpg",
            "https://www.dsmtuners.com/data/attachments/566/566699-4ccf483b0316496606e5ea601bb1d89b.jpg",
            "https://www.dsmtuners.com/data/attachments/566/566698-57b51efa9eaadf4b6276a4ee83759bb2.jpg",
            "https://www.dsmtuners.com/data/attachments/566/566705-01f9bfc70f4586d00f5fd309fe71e95f.jpg",
            "https://www.dsmtuners.com/data/attachments/635/635019-fa701c5f2fa0eb553be6c3827f397e4b.jpg",
            "https://www.dsmtuners.com/data/attachments/139/139746-62bcc2847d7ab45291fd9384cfb1d3c5.jpg",
            "https://www.dsmtuners.com/images/ff/ff-epsi-fuelpump.jpg",
            "https://www.dsmtuners.com/data/avatars/s/27/27748.jpg?1137050365",
            "https://www.dsmtuners.com/data/avatars/s/83/83218.jpg?1269134523",
            "https://www.dsmtuners.com/data/avatars/s/150/150362.jpg?1635328140",
            "https://www.dsmtuners.com/data/avatars/s/128/128994.jpg?1591126686",
            "https://www.dsmtuners.com/data/avatars/s/77/77114.jpg?1460811474",
            "https://www.dsmtuners.com/data/avatars/s/5/5022.jpg?1384787389",
            "https://www.dsmtuners.com/data/avatars/s/5/5022.jpg?1384787389",
            "https://www.dsmtuners.com/images/vendors/logo-boosted-fabrication.png",
            "https://www.dsmtuners.com/images/vendors/logo-ecmtuning.png",
            "https://www.dsmtuners.com/images/vendors/logo-epsi.png",
            "https://www.dsmtuners.com/images/vendors/logo-fic.png",
            "https://www.dsmtuners.com/images/vendors/logo-innovation-products.jpg",
            "https://www.dsmtuners.com/images/vendors/logo-jacks.png",
            "https://www.dsmtuners.com/images/vendors/logo-jnz.png",
            "https://www.dsmtuners.com/images/vendors/1019_1.jpg",
            "https://www.dsmtuners.com/images/vendors/logo-morrison-fabrications.png",
            "https://www.dsmtuners.com/images/vendors/logo-mymitsubishistore.png",
            "https://www.dsmtuners.com/images/vendors/logo-rixracing.png",
            "https://www.dsmtuners.com/images/vendors/logo-rockauto.png",
            "https://www.dsmtuners.com/images/vendors/logo-rtmracing.gif",
            "https://www.dsmtuners.com/images/vendors/logo-stmtuned.jpg",
            "https://www.dsmtuners.com/data/avatars/s/0/164.jpg?1333338170",
            "https://www.dsmtuners.com/data/avatars/s/133/133404.jpg?1360374418",
            "https://www.dsmtuners.com/data/avatars/s/0/164.jpg?1333338170",
            "https://www.dsmtuners.com/data/avatars/s/125/125006.jpg?1723479709",
            "https://www.dsmtuners.com/data/avatars/s/170/170741.jpg?1694708963",
            "https://www.dsmtuners.com/data/avatars/s/181/181777.jpg?1647563242",
            "https://www.dsmtuners.com/data/avatars/s/99/99950.jpg?1657518315",
            "https://www.dsmtuners.com/data/avatars/s/99/99950.jpg?1657518315",
            "https://www.dsmtuners.com/data/avatars/s/187/187758.jpg?1681227735",
            "https://www.dsmtuners.com/data/avatars/s/154/154629.jpg?1689643704",
            "https://www.dsmtuners.com/data/avatars/s/125/125006.jpg?1723479709",
            "https://www.dsmtuners.com/data/avatars/s/170/170741.jpg?1694708963",
            "https://www.dsmtuners.com/data/avatars/s/187/187758.jpg?1681227735",
            "https://www.dsmtuners.com/data/avatars/s/154/154629.jpg?1689643704",
            "https://www.dsmtuners.com/data/avatars/s/36/36343.jpg?1489712253",
            "https://www.dsmtuners.com/data/avatars/s/149/149508.jpg?1574612475",
            "https://www.dsmtuners.com/data/avatars/s/179/179594.jpg?1722658466",
            "https://www.dsmtuners.com/data/avatars/s/159/159072.jpg?1670957762",
            "https://www.dsmtuners.com/data/avatars/s/168/168993.jpg?1641620290",
            "https://www.dsmtuners.com/data/avatars/s/80/80523.jpg?1676464981",
            "https://www.dsmtuners.com/images/ebay-logo.jpg",
            "https://www.dsmtuners.com/images/Amazon-logo.png"
        ],
        "movies": [],
        "keywords": [],
        "meta_keywords": [
            ""
        ],
        "tags": null,
        "authors": [],
        "publish_date": "2022-09-10T14:38:00-05:00",
        "summary": "",
        "meta_description": "Not sure how many people are still playing with the stock code, but I noticed that the deadtime table address when loaded by code is FC E5. The actual...",
        "meta_lang": "en",
        "meta_favicon": "/data/assets/logo/dsmtuners-icon-192.png",
        "meta_site_name": "DSMtuners.com",
        "canonical_link": "https://www.dsmtuners.com/threads/e931-eprom-deadtime-address-off-by-2-bytes.541572/",
        "text": "Not sure how many people are still playing with the stock code, but I noticed that the deadtime table address when loaded by code is FC E5. The actual deadtime table starts at FCE7 however. I have logged it to verify it is working correctly but i dont understand the offset. I dont believe i've seen any of the other tables offset like this. Below is the code snippet where the table is loaded.\n\n3796 D9DA ;----------------------------\n\n3797 D9DA ; Compute injector deadTime\n\n3798 D9DA ;----------------------------\n\n3799 D9DA CE FC E5 ldx #t_deadtime-2\n\n3800 D9DD 96 D0 ldaa battRaw\n\n3801 D9DF BD EB 4C jsr interp32\n\n3802 D9E2 D7 A6 stab deadTime\n\nBelow is the table address:\n\n13491 FCE7 ;******************************************************************\n\n13492 FCE7 ;\n\n13493 FCE7 ;\n\n13494 FCE7 ; Injector deatime as a function of battery voltage\n\n13495 FCE7 ;\n\n13496 FCE7 ; Each unit correspond to 24us ($08 = 192us)\n\n13497 FCE7 ;\n\n13498 FCE7 ;\n\n13499 FCE7 ; Volts: 4.7, 7.0, 9.4, 11.7, 14.1, 16.4, 18.8\n\n13500 FCE7 ;\n\n13501 FCE7 ;******************************************************************\n\n13502 FCE7 t_deadtime\n\n13510 FCE7 #ifdef E931\n\n13511 FCE7 A9 58 30 23 .byte $a9, $58, $30, $23, $1b, $17, $13\n\n13511 FCEB 1B 17 13\n\nJust trying to get a better understanding of how this works.\n\nDon't quote me on this, but it might be because the ADC would never read a sufficiently low value (voltage for the battery) becuase at some point the battery is basically dead and the ECU wouldn't be able to run anyway. So since it will never interpolate a value from the first point(s?) in the table anyway, just point into the table before to save space (not having code to handle the special case saves space too). Pure guess at this point.\n\nYeah it is strange because in the stock ROM the address actually points to the last 2 bytes of the fuel table. In the rom I use there is blank space before the deadtime table, and when I checked the address it was called from it was 2 bytes off as well so I thought it was an error. Turned out it wasn't . It might have something to do with how 8 bit and 16bit values are handled too. I have not been able to find another example of it in the code either.\n\n@redrkt: The more I look at it the more I am convinced my answer might just be correct. Looking at the commented code in the OP we see the values `Volts: 4.7, 7.0, 9.4, 11.7, 14.1, 16.4, 18.8` with the 4.7v minimum being suspiciously close the 5v operating voltage of the processor and logic circuits of the ECU. Given that it is just below that value, and the losses from the voltage regulator etc it seems pretty reasonable that the processor wouldn't be functioning, or at least \"in-charge\" (limp-home-mode watch-dog might take over??) anywhere below this value. The battRaw is, well, the raw ADC value. So if we plug in the minimum (4.7v) into `interp32`, what does it look like?\n\n8164 EB4C ;******************************************************************\n\n8165 EB4C ;\n\n8166 EB4C ; Table lookup with fractional interpolation\n\n8167 EB4C ; input value = A\n\n8168 EB4C ; input table = X\n\n8169 EB4C ; output value in a and b is (interpolated table) = X(A/32)\n\n8170 EB4C ;\n\n8171 EB4C ;\n\n8172 EB4C ;******************************************************************\n\n;X=0xFCE5 = #t_deadtime-2\n\n;A=battRaw = BATTERY VOLTAGE = (.0733x)v = (18.8 = $FF max, 4.7v = $40 min)\n\n;B=THROWN AWAY\n\n;\n\n8173 EB4C 5F interp32 clrb ;\n\n;\n\n;D=A+0(B) max = 0xFF00, min = 0x4000 (let's focus on min)\n\n;\n\n8174 EB4D 04 lsrd ;\n\n;\n\n;D=0x2000\n\n;\n\n8175 EB4E 04 interp16 lsrd ;\n\n;\n\n;D=0x1000\n\n;\n\n8176 EB4F 04 lsrd ;\n\n;\n\n;D=0x0800\n\n;\n\n8177 EB50 04 lsrd ;\n\n;\n\n;D=0x0400\n\n;\n\n8178 EB51 04 lsrd ; A=A/32, B = 5 LSB of A in upper part\n\n;\n\n;D=0x0200; A=0x02; B=0x00\n\n;\n\n8179 EB52 37 interp1 pshb ; \\\n\n;\n\n;stack--\n\n;*stack=B (0x00)\n\n;\n\n8180 EB53 16 tab ; >transfer A to B, only 3 bits left\n\n;\n\n;B=A (0x02)\n\n;\n\n8181 EB54 32 pula ; / At this point, B=integer part of input/32, A=fractional part\n\n;\n\n;A=*stack (0x00)\n\n;stack++\n\n;\n\n8182 EB55 3A abx ; ADD B TO X: B = 0 to 7 (3 bits) (integer table lookup), X=V(0)\n\n;\n\n;X = X (0xFCE5) + B (0x02) = 0xFCE7\n\n;\n\nThere we go, `0xFCE7`. Of course the value of 4.7 was found by running the processes backward and seeing that the algorithm only worked to that limit. The choice of that limit is what seems thought out.\n\n@bastarddsm: I might be able to help with that 2-byte map\n\nI dug through the DSM-ECU archives and found this:\n\nFrom: \"o8ford\" <jr@...>\n\nSubject: Re: problem with saving deadtime running lean at idle\n\nX-Yahoo-Group-Post: member; u=325979280; y=RsnWVvWUjSaLwK2XiRaMAoiuFweVGo6-LU3b42bSjKdK\n\nX-Yahoo-Profile: o8ford\n\nThat value is already maxed out then. You can't get down to 4.7V anyways, =\n\nso it doesn't effect anything; if it was possible to get down to 4.7V, the =\n\ncar wouldn't run on that low of voltage.\n\nDon't worry about it.\n\nLooks like that was Wed Jun 24 16:49:59 2009 UTC\n\nI think I see what your saying Jane and it does make sense. Im going to look at that section of code some more. Thanks for the help.\n\nCould you post the link to the DSM Ecu archives? I thought they were lost.\n\nI am interested in the 2 byte map as well. ID like to try making a 2byte fuel map for the Swd code im running. ID like to make it so the fuel map contains the IPw values to use.\n\nSuch a shame this a dying art these days, not to thread jack but I was always fascinated in this as an alternative way around the plug n play solutions but even 10 years ago when I started paying any mind to it it was already dying out for the most part. I fear with the way the world is and supply issues that in another year or few this could again be a viable option for some if certain things become unavailable however there’s so few left that know how to utilize it I don’t believe it will be. Glad to see a few of you still keeping it alive."
    }
}