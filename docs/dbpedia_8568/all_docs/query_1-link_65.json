{
    "id": "dbpedia_8568_1",
    "rank": 65,
    "data": {
        "url": "https://lore.kernel.org/lkml/20220829100850.1474-1-santosh.shukla%40amd.com/",
        "read_more_link": "",
        "language": "en",
        "title": "[PATCHv4 0/8] Virtual NMI feature",
        "top_image": "",
        "meta_img": "",
        "images": [],
        "movies": [],
        "keywords": [],
        "meta_keywords": [
            ""
        ],
        "tags": null,
        "authors": [],
        "publish_date": null,
        "summary": "",
        "meta_description": "",
        "meta_lang": "",
        "meta_favicon": "",
        "meta_site_name": "",
        "canonical_link": null,
        "text": "linux-kernel.vger.kernel.org archive mirror help / color / mirror / Atom feed\n\nFrom: Santosh Shukla <santosh.shukla@amd.com> To: Paolo Bonzini <pbonzini@redhat.com> Cc: Sean Christopherson <seanjc@google.com>, Vitaly Kuznetsov <vkuznets@redhat.com>, Jim Mattson <jmattson@google.com>, Joerg Roedel <joro@8bytes.org>, Tom Lendacky <thomas.lendacky@amd.com>, <kvm@vger.kernel.org>, <linux-kernel@vger.kernel.org>, <santosh.shukla@amd.com>, <mlevitsk@redhat.com>, <mail@maciej.szmigiero.name> Subject: [PATCHv4 0/8] Virtual NMI feature Date: Mon, 29 Aug 2022 15:38:42 +0530 [thread overview] Message-ID: <20220829100850.1474-1-santosh.shukla@amd.com> (raw) Change History: v4 (v6.0-rc3): 05 - added nmi_l1_to_l2 check (Review comment from Maciej). v3 (rebased on eb555cb5b794f): https://lore.kernel.org/all/20220810061226.1286-1-santosh.shukla@amd.com/ v2: https://lore.kernel.org/lkml/20220709134230.2397-7-santosh.shukla@amd.com/T/#m4bf8a131748688fed00ab0fefdcac209a169e202 v1: https://lore.kernel.org/all/20220602142620.3196-1-santosh.shukla@amd.com/ Description: Currently, NMI is delivered to the guest using the Event Injection mechanism [1]. The Event Injection mechanism does not block the delivery of subsequent NMIs. So the Hypervisor needs to track the NMI delivery and its completion(by intercepting IRET) before sending a new NMI. Virtual NMI (VNMI) allows the hypervisor to inject the NMI into the guest w/o using Event Injection mechanism meaning not required to track the guest NMI and intercepting the IRET. To achieve that, VNMI feature provides virtualized NMI and NMI_MASK capability bits in VMCB intr_control - V_NMI(11) - Indicates whether a virtual NMI is pending in the guest. V_NMI_MASK(12) - Indicates whether virtual NMI is masked in the guest. V_NMI_ENABLE(26) - Enables the NMI virtualization feature for the guest. When Hypervisor wants to inject NMI, it will set V_NMI bit, Processor will clear the V_NMI bit and Set the V_NMI_MASK which means the Guest is handling NMI, After the guest handled the NMI, The processor will clear the V_NMI_MASK on the successful completion of IRET instruction Or if VMEXIT occurs while delivering the virtual NMI. If NMI virtualization enabled and NMI_INTERCEPT bit is unset then HW will exit with #INVALID exit reason. To enable the VNMI capability, Hypervisor need to program V_NMI_ENABLE bit 1. The presence of this feature is indicated via the CPUID function 0x8000000A_EDX[25]. Testing - * Used qemu's `inject_nmi` for testing. * tested with and w/o AVIC case. * tested with kvm-unit-test * tested with vGIF enable and disable. * tested nested env: - L1+L2 using vnmi - L1 using vnmi and L2 not Thanks, Santosh [1] https://www.amd.com/system/files/TechDocs/40332.pdf - APM Vol2, ch-15.20 - \"Event Injection\". Santosh Shukla (8): x86/cpu: Add CPUID feature bit for VNMI KVM: SVM: Add VNMI bit definition KVM: SVM: Add VNMI support in get/set_nmi_mask KVM: SVM: Report NMI not allowed when Guest busy handling VNMI KVM: SVM: Add VNMI support in inject_nmi KVM: nSVM: implement nested VNMI KVM: nSVM: emulate VMEXIT_INVALID case for nested VNMI KVM: SVM: Enable VNMI feature arch/x86/include/asm/cpufeatures.h | 1 + arch/x86/include/asm/svm.h | 7 +++ arch/x86/kvm/svm/nested.c | 32 ++++++++++++++ arch/x86/kvm/svm/svm.c | 44 ++++++++++++++++++- arch/x86/kvm/svm/svm.h | 68 ++++++++++++++++++++++++++++++ 5 files changed, 151 insertions(+), 1 deletion(-) -- 2.25.1\n\nnext reply other threads:[~2022-08-29 10:09 UTC|newest] Thread overview: 17+ messages / expand[flat|nested] mbox.gz Atom feed top 2022-08-29 10:08 Santosh Shukla [this message] 2022-08-29 10:08 ` [PATCHv4 1/8] x86/cpu: Add CPUID feature bit for VNMI Santosh Shukla 2022-08-31 23:42 ` Jim Mattson 2022-09-01 12:45 ` Shukla, Santosh 2022-09-01 17:43 ` Jim Mattson 2022-09-05 7:49 ` Shukla, Santosh 2022-08-29 10:08 ` [PATCHv4 2/8] KVM: SVM: Add VNMI bit definition Santosh Shukla 2022-08-29 10:08 ` [PATCHv4 3/8] KVM: SVM: Add VNMI support in get/set_nmi_mask Santosh Shukla 2022-08-29 10:08 ` [PATCHv4 4/8] KVM: SVM: Report NMI not allowed when Guest busy handling VNMI Santosh Shukla 2022-08-29 10:08 ` [PATCHv4 5/8] KVM: SVM: Add VNMI support in inject_nmi Santosh Shukla 2022-08-29 10:08 ` [PATCHv4 6/8] KVM: nSVM: implement nested VNMI Santosh Shukla 2022-08-29 10:08 ` [PATCHv4 7/8] KVM: nSVM: emulate VMEXIT_INVALID case for \" Santosh Shukla 2022-08-29 10:08 ` [PATCHv4 8/8] KVM: SVM: Enable VNMI feature Santosh Shukla 2022-10-06 18:40 ` [PATCHv4 0/8] Virtual NMI feature Sean Christopherson 2022-10-10 5:46 ` Santosh Shukla 2022-10-10 15:51 ` Sean Christopherson 2022-10-16 5:49 ` Santosh Shukla\n\nReply instructions: You may reply publicly to this message via plain-text email using any one of the following methods: * Save the following mbox file, import it into your mail client, and reply-to-all from there: mbox Avoid top-posting and favor interleaved quoting: https://en.wikipedia.org/wiki/Posting_style#Interleaved_style * Reply using the --to, --cc, and --in-reply-to switches of git-send-email(1): git send-email \\ --in-reply-to=20220829100850.1474-1-santosh.shukla@amd.com \\ --to=santosh.shukla@amd.com \\ --cc=jmattson@google.com \\ --cc=joro@8bytes.org \\ --cc=kvm@vger.kernel.org \\ --cc=linux-kernel@vger.kernel.org \\ --cc=mail@maciej.szmigiero.name \\ --cc=mlevitsk@redhat.com \\ --cc=pbonzini@redhat.com \\ --cc=seanjc@google.com \\ --cc=thomas.lendacky@amd.com \\ --cc=vkuznets@redhat.com \\ /path/to/YOUR_REPLY https://kernel.org/pub/software/scm/git/docs/git-send-email.html * If your mail client supports setting the In-Reply-To header via mailto: links, try the mailto: link\n\nBe sure your reply has a Subject: header at the top and a blank line before the message body."
    }
}